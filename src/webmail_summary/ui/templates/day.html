{% extends "base.html" %}
{% block content %}
<section class="hero">
  <div class="hero__row">
    <div>
      <p class="muted" style="margin-bottom: 4px;">{{ t(request, 'day.subtitle') }}</p>
      <h1>{{ day }}</h1>
    </div>
    <div class="hero__actions day-actions">
      {% if not setup_complete %}
        <a class="btn" href="/setup">{{ t(request, 'home.btn.setup') }}</a>
      {% elif active_resum %}
        {# Progress is already visible #}
      {% else %}
        <button id="btn-resummarize" class="btn">{% if ui_lang(request) == 'ko' %}오류/누락만 다시 요약{% else %}Resummarize (failed only){% endif %}</button>
        <button id="btn-resummarize-all" class="btn">{% if ui_lang(request) == 'ko' %}전체 다시 요약{% else %}Resummarize (all){% endif %}</button>
        <button id="btn-resummarize-selected" class="btn btn--secondary" disabled>{% if ui_lang(request) == 'ko' %}선택 다시 요약 (0){% else %}Resummarize selected (0){% endif %}</button>
      {% endif %}
      <a class="btn btn--secondary" href="/">{{ t(request, 'day.back') }}</a>
    </div>
  </div>
</section>

{% if active and (active.sync or active.refresh_overviews) %}
<div class="card span-4" id="global-job-wrap" style="margin-bottom: 24px; border-color: var(--accent);">
  <div class="card__title" style="font-size: 1rem; display: flex; justify-content: space-between;">
    <span>{% if active.sync %}Global Sync{% else %}Refreshing Overviews{% endif %}</span>
    <span class="muted" style="font-size: 0.75rem;">Running in background...</span>
  </div>
  <div class="card__body">
    <div class="bar"><div class="bar__fill" id="global-bar" style="width:0%"></div></div>
    <div class="muted" id="global-text" style="margin-top: 8px; font-size: 12px;">...</div>
  </div>
</div>
{% endif %}


<div id="resum-wrap" class="card span-4" style="display:none; margin-bottom: 24px; border-color: var(--accent);">
  <div class="card__title">{% if ui_lang(request) == 'ko' %}재요약 진행 중{% else %}Resummarizing{% endif %}</div>
  <div class="card__body">
    <div class="bar"><div class="bar__fill" id="resum-bar"></div></div>
    <div class="muted" id="resum-text" style="margin-top: 8px;">...</div>
    
    <div class="stepper" id="resum-stepper" style="margin-top: 24px;">
      <div class="stepper__track" id="resum-track" style="width:0%"></div>
      <div class="step" data-step="read">
        <div class="step__dot">R</div>
        <div class="step__label">{% if ui_lang(request) == 'ko' %}읽기{% else %}Read{% endif %}</div>
      </div>
      <div class="step" data-step="llm">
        <div class="step__dot">AI</div>
        <div class="step__label">{% if ui_lang(request) == 'ko' %}요약{% else %}Summarize{% endif %}</div>
      </div>
      <div class="step" data-step="save">
        <div class="step__dot">S</div>
        <div class="step__label">{% if ui_lang(request) == 'ko' %}저장{% else %}Save{% endif %}</div>
      </div>
      <div class="step" data-step="export">
        <div class="step__dot">E</div>
        <div class="step__label">{% if ui_lang(request) == 'ko' %}내보내기{% else %}Export{% endif %}</div>
      </div>
    </div>

    <div id="resum-sub-wrap" style="display:none; margin-top:24px;">
      <div class="muted" style="font-size:11px; margin-bottom:8px; display:flex; justify-content:space-between;">
        <span id="resum-sub-label">{% if ui_lang(request) == 'ko' %}AI 분석 단계{% else %}AI Analysis Stage{% endif %}</span>
        <span id="resum-sub-pct" class="mono">0.00%</span>
      </div>
      <div class="bar" style="height:6px;"><div class="bar__fill" id="resum-sub-bar" style="width:0%;"></div></div>
    </div>

    <div class="muted" id="resum-stage" style="display:none; margin-top:16px; text-align:center; font-size:12px;"></div>
    <div id="resum-current" style="display:none; margin-top: 8px; font-weight: 600; text-align: center;"></div>
  </div>
</div>

<div class="bento-grid">
  {% for it in items %}
    <div class="card span-4" style="padding: 0;">
      <div class="rowlink" style="padding: 20px; border-bottom: 1px solid var(--border);">
        <div style="display: flex; gap: 16px; align-items: flex-start; flex: 1; min-width: 0;">
          <input type="checkbox" class="msg-select" value="{{ it.id }}" style="width: 20px; height: 20px; flex: 0 0 auto; margin-top: 4px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ it.subject }}">{{ it.subject }}</div>
            <div class="muted" style="font-size: 0.8rem;">{{ it.time_full }}{% if it.summarize_ms %} · 요약 {{ it.summarize_ms }}{% endif %}</div>
          </div>
        </div>
        <div class="day-item-actions" style="flex: 0 0 auto; margin-left: 20px;">
          {% if it.has_rendered %}
            <a class="btn btn--secondary" href="/m/{{ it.id }}/rendered.html" target="_blank" style="padding: 6px 12px; font-size: 0.8rem;">원문</a>
          {% endif %}
          <a class="btn" href="/message/{{ it.id }}?return_to={{ day }}" style="padding: 6px 12px; font-size: 0.8rem;">{{ t(request, 'day.open_detail') }}</a>
        </div>
      </div>
      <div class="card__body" style="padding: 20px;">
        <div class="summary-content" data-message-id="{{ it.id }}" style="font-size: 0.95rem; line-height: 1.6;" data-raw="{{ it.summary }}"></div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
(() => {
  // Summary formatting logic is now handled by global /static/app.js
  const applyFormatting = () => window.applyFormatting('.summary-content');

  // --- UI State & Constants ---
  const btn = document.getElementById('btn-resummarize');
  const btnAll = document.getElementById('btn-resummarize-all');
  const btnSel = document.getElementById('btn-resummarize-selected');
  const wrap = document.getElementById('resum-wrap'), bar = document.getElementById('resum-bar'), text = document.getElementById('resum-text');
  const curEl = document.getElementById('resum-current'), stageEl = document.getElementById('resum-stage');
  const stepperEl = document.getElementById('resum-stepper'), trackEl = document.getElementById('resum-track');
  const subWrap = document.getElementById('resum-sub-wrap'), subBar = document.getElementById('resum-sub-bar'), subPct = document.getElementById('resum-sub-pct');
  const checkboxes = Array.from(document.querySelectorAll('input.msg-select'));
  const globalWrap = document.getElementById('global-job-wrap'), globalBar = document.getElementById('global-bar'), globalText = document.getElementById('global-text');

  const LABEL_FAILED = {{ ("오류/누락만 다시 요약" if ui_lang(request) == 'ko' else "Resummarize (failed only)")|tojson }};
  const LABEL_ALL = {{ ("전체 다시 요약" if ui_lang(request) == 'ko' else "Resummarize (all)")|tojson }};
  const LABEL_STOP = {{ ("중단" if ui_lang(request) == 'ko' else "Stop")|tojson }};

  let activeJobId = null, es = null, globalEs = null;

  // --- Helper Functions ---
  function selectedIds() { return checkboxes.filter(cb => cb.checked).map(cb => Number(cb.value || 0)); }
  function syncSelectedUi() {
    const ids = selectedIds();
    if (activeJobId) { if(btnSel) btnSel.disabled = true; checkboxes.forEach(cb => cb.disabled = true); return; }
    checkboxes.forEach(cb => cb.disabled = false);
    if(btnSel) { 
      btnSel.disabled = ids.length === 0; 
      btnSel.textContent = LABEL_ALL.replace("전체", "선택").replace("(all)", "selected") + " (" + ids.length + ")"; 
    }
  }

  function setProgress(pct, msg) {
    if (!wrap || !bar || !text) return;
    const p = Math.max(0, Math.min(100, pct));
    wrap.style.display = 'block'; bar.style.width = p + '%'; text.textContent = (msg || '...') + ' (' + p + '%)';
  }

  function setStage(stage, extra) {
    if (!stageEl || !stepperEl) return;
    stageEl.style.display = 'block'; stepperEl.style.display = 'flex';
    const st = String(stage || ''), ex = String(extra || '');
    if (subWrap) subWrap.style.display = (st === 'llm' || st === 'synthesis') ? 'block' : 'none';
    const labels = { read: "읽는 중", llm: "요약 중", synthesis: "합성 중", save: "저장 중", export: "내보내는 중" };
    stageEl.textContent = (labels[st] || st) + (ex ? ' (' + ex + ')' : '');
    const stages = ['read', 'llm', 'save', 'export'];
    const activeIdx = stages.indexOf(st === 'synthesis' ? 'llm' : st);
    stepperEl.querySelectorAll('.step').forEach((n, idx) => {
      if (idx < activeIdx) n.setAttribute('data-state', 'completed');
      else if (idx === activeIdx) n.setAttribute('data-state', 'active');
      else n.setAttribute('data-state', 'pending');
    });
    if (trackEl) trackEl.style.width = activeIdx < 0 ? '0%' : (activeIdx * 33.3) + '%';
  }

  function setButtonsIdle() {
    activeJobId = null; 
    if(btn) { btn.textContent = LABEL_FAILED; btn.disabled = false; }
    if(btnAll) { btnAll.textContent = LABEL_ALL; btnAll.disabled = false; }
    syncSelectedUi();
  }

  function setButtonsRunning(starter) {
    if (starter === 'failed' && btn) { btn.textContent = LABEL_STOP; btnAll.disabled = true; btnSel.disabled = true; }
    else if (starter === 'all' && btnAll) { btnAll.textContent = LABEL_STOP; btn.disabled = true; btnSel.disabled = true; }
    else if (btnSel) { btnSel.textContent = LABEL_STOP; btn.disabled = true; btnAll.disabled = true; }
    checkboxes.forEach(cb => cb.disabled = true);
  }

  async function requestCancel() {
    if (!activeJobId) return;
    [btn, btnAll, btnSel].forEach(b => { if(b) b.disabled = true; });
    setProgress(100, "중단 중...");
    try { await fetch('/api/jobs/' + activeJobId + '/cancel', { method: 'POST' }); } catch(e) {}
  }

  function watchGlobal(jobId) {
    if (!jobId || !globalWrap) return;
    if (globalEs) { try { globalEs.close(); } catch(e) {} }
    globalEs = new EventSource('/api/jobs/' + jobId + '/events');
    globalEs.addEventListener('progress', (ev) => {
      const p = JSON.parse(ev.data);
      const pct = Math.max(0, Math.min(100, (Number(p.current||0)/Number(p.total||1))*100));
      if (globalBar) globalBar.style.width = pct + '%';
      if (globalText) globalText.textContent = (p.message || '...') + ' (' + pct.toFixed(2) + '%)';
      if (p.status === 'succeeded' || p.status === 'failed' || p.status === 'cancelled') {
        try { globalEs.close(); } catch(e) {} globalEs = null;
        setTimeout(() => { if (globalWrap) globalWrap.style.display = 'none'; }, 3000);
      }
    });
  }

  async function startResummarize(onlyFailed, starter, messageIds, reattachId) {
    if (reattachId) { activeJobId = reattachId; setButtonsRunning(starter); }
    else {
      setButtonsRunning(starter);
      const res = await fetch('/api/jobs/resummarize-day', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ date_key: '{{ day }}', only_failed: !!onlyFailed, message_ids: messageIds }) 
      });
      const j = await res.json();
      if (!res.ok) { setProgress(0, "오류: " + (j.error || 'failed')); setButtonsIdle(); return; }
      activeJobId = j.job_id;
    }
    if (es) es.close();
    es = new EventSource('/api/jobs/' + activeJobId + '/events');
    es.addEventListener('message_updated', (ev) => {
      const u = JSON.parse(ev.data);
      const el = document.querySelector('.summary-content[data-message-id="' + u.message_id + '"]');
      if (el && u.summary) { el.setAttribute('data-raw', u.summary.trim()); el.innerHTML = formatSummary(u.summary.trim()); }
    });
    let subPctTarget = 0, subPctCurrent = 0, subTimer = null;
    function animate() {
      if (!subBar || !subPct) return;
      if (subPctCurrent < subPctTarget) subPctCurrent += Math.max(0.1, (subPctTarget - subPctCurrent) * 0.1); else if (subPctCurrent < 98) subPctCurrent += 0.01;
      subBar.style.width = subPctCurrent.toFixed(2) + '%'; subPct.textContent = subPctCurrent.toFixed(2) + '%';
      subTimer = requestAnimationFrame(animate);
    }
    es.addEventListener('detail', (ev) => {
      const d = JSON.parse(ev.data);
      if (d.type === 'email' && curEl) { curEl.style.display = 'block'; curEl.textContent = (d.index + '/' + d.total + ' ') + d.subject; subPctCurrent = 0; subPctTarget = 2; if(!subTimer) animate(); }
      if (d.type === 'stage') { setStage(d.stage, ''); if(d.stage==='synthesis') subPctTarget=95; if(d.stage==='save'||d.stage==='export') subPctTarget=100; }
      if (d.type === 'chunk') { setStage('llm', 'part '+d.index+'/'+d.total); subPctTarget=(d.index/(d.total+1))*100; if(!subTimer) animate(); }
    });
    es.addEventListener('progress', (ev) => {
      const p = JSON.parse(ev.data); const pct = (Number(p.current||0)/Number(p.total||1))*100;
      if (p.status === 'cancel_requested') { setProgress(100, "중단 중..."); return; }
      setProgress(pct.toFixed(2), p.message);
      if (p.status === 'failed') { 
        if (subTimer) cancelAnimationFrame(subTimer);
        es.close(); setButtonsIdle(); setProgress(0, "오류: " + p.message); 
      }
      if (p.status === 'succeeded' || p.status === 'cancelled') { 
        if (subTimer) cancelAnimationFrame(subTimer);
        es.close(); setButtonsIdle(); setTimeout(() => location.reload(), 1200); 
      }

      setProgress(pct.toFixed(2), p.message);
      if (p.status === 'failed') { es.close(); setButtonsIdle(); setProgress(0, "오류: " + p.message); }
      if (p.status === 'succeeded' || p.status === 'cancelled') { es.close(); setButtonsIdle(); setTimeout(() => location.reload(), 1200); }
    });
  }

  // --- Execution ---
  const ACTIVE_SYNC = "{{ (active.sync.id if active and active.sync else '') }}";
  const ACTIVE_REFRESH = "{{ (active.refresh_overviews.id if active and active.refresh_overviews else '') }}";
  if (ACTIVE_SYNC) watchGlobal(ACTIVE_SYNC);
  else if (ACTIVE_REFRESH) watchGlobal(ACTIVE_REFRESH);

  applyFormatting();
  checkboxes.forEach(cb => cb.addEventListener('change', syncSelectedUi));
  const ACTIVE_RESUM = {% if active_resum %}{{ active_resum|tojson }}{% else %}null{% endif %};
  const GLOBAL_ACTIVE_RESUM = {% if active and active.resummarize %}{{ active.resummarize|tojson }}{% else %}null{% endif %};

  if (ACTIVE_RESUM) {
    const pct = Math.max(0, Math.min(100, (Number(ACTIVE_RESUM.current || 0) / Number(ACTIVE_RESUM.total || 1)) * 100));
    setProgress(pct.toFixed(2), ACTIVE_RESUM.message);
    let starter = 'all';
    if (ACTIVE_RESUM.message.includes('오류/누락')) starter = 'failed';
    else if (ACTIVE_RESUM.message.includes('선택')) starter = 'selected';
    startResummarize(false, starter, null, ACTIVE_RESUM.id);
  } else if (GLOBAL_ACTIVE_RESUM) {
    const jobDay = GLOBAL_ACTIVE_RESUM.date_key;
    if (jobDay && jobDay !== "{{ day }}") {
        [btn, btnAll, btnSel].forEach(b => { if(b) b.disabled = true; });
        setProgress(0, "{% if ui_lang(request) == 'ko' %}다른 날짜의 요약 작업이 진행 중입니다.{% else %}Another day's summarization is in progress.{% endif %} (" + jobDay + ")");
    }
  }

  if (btn) btn.addEventListener('click', () => activeJobId ? requestCancel() : startResummarize(true, 'failed', null));
  if (btnAll) btnAll.addEventListener('click', () => activeJobId ? requestCancel() : (confirm("전체 다시 요약하시겠습니까?") && startResummarize(false, 'all', null)));
  if (btnSel) btnSel.addEventListener('click', () => activeJobId ? requestCancel() : startResummarize(false, 'selected', selectedIds()));
})();

</script>

{% endblock %}
