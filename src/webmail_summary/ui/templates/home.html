{% extends "base.html" %}
{% block content %}
<section class="hero">
  <div class="hero__inner">
    {% if flash and flash.saved %}
      <div class="notice notice--ok" id="flash-saved">
        <div><strong>{{ t(request, 'home.notice.saved.title') }}</strong> {{ t(request, 'home.notice.saved.body') }}</div>
      </div>
      <script>
      (() => {
        try {
          const u = new URL(location.href);
          u.searchParams.delete('saved');
          history.replaceState(null, '', u.toString());
        } catch (e) {}
      })();
      </script>
    {% endif %}
    <div class="hero__row">
      <div>
        <h1>{{ t(request, 'home.hero.title') }}</h1>
        <p class="muted">{{ t(request, 'home.hero.sub') }}</p>
      </div>
      <div class="hero__actions">
        <button id="btn-sync" {% if not ai.ready %}disabled{% endif %}>{{ t(request, 'home.btn.sync') }}</button>
        <a class="btnlink" href="/setup">{{ t(request, 'home.btn.setup') }}</a>
      </div>
    </div>

    {% if not ai.setup_complete %}
      <div class="notice notice--err" style="margin-top:12px; padding: 20px; text-align: center;">
        <div style="font-size: 18px; margin-bottom: 10px;"><strong>{{ t(request, 'setup.ai.not_ready.title') }}</strong></div>
        <p>{{ t(request, 'setup.ai.not_ready.body') }}</p>
        <div style="margin-top:20px;">
            <a class="btnlink" href="/setup" style="background: var(--accent); color: #fff; padding: 12px 24px; font-weight: bold; font-size: 16px;">{{ t(request, 'home.btn.setup') }}</a>
        </div>
      </div>
    {% endif %}

    <div class="card">
      <div class="card__title">{{ t(request, 'home.card.progress') }}</div>
      <div class="card__body">
        <div id="sync-progress-box">
          <div class="bar"><div class="bar__fill" id="sync-bar" style="width:0%"></div></div>
          <div class="muted" id="sync-text">{% if ui_lang(request) == 'ko' %}대기{% else %}Idle{% endif %}</div>

          <div class="stepper" id="sync-stepper" style="display:none; margin-top:16px;">
            <div class="stepper__track" id="sync-track" style="width:0%"></div>
            <div class="step" data-step="archive">
              <div class="step__dot">A</div>
              <div class="step__label">{% if ui_lang(request) == 'ko' %}백업{% else %}Archive{% endif %}</div>
            </div>
            <div class="step" data-step="summarize">
              <div class="step__dot">AI</div>
              <div class="step__label">{% if ui_lang(request) == 'ko' %}요약{% else %}Summarize{% endif %}</div>
            </div>
            <div class="step" data-step="export">
              <div class="step__dot">O</div>
              <div class="step__label">Obsidian</div>
            </div>
          </div>
        </div>

        <a id="resum-progress-box" href="#" style="display:none; margin-top:10px; padding-top:10px; border-top: 1px dashed var(--line); text-decoration:none; color:inherit;">
          <div class="muted" style="font-size:12px; margin-bottom:6px;">{% if ui_lang(request) == 'ko' %}날짜별 재요약 진행 중... (클릭하여 이동){% else %}Resummarizing day... (Click to view){% endif %}</div>
          <div class="bar" style="height:8px;"><div class="bar__fill" id="resum-bar" style="width:0%; background: var(--accent);"></div></div>
          <div class="muted" id="resum-text" style="font-size:11px;">...</div>
        </a>

        <div class="muted" id="sync-log" style="margin-top:12px; display:none; font-size:11px; text-align:center;"></div>
      </div>
    </div>

    <div id="day-list-container">
      {% for d in days %}
        <a class="day" href="/day/{{ d.day }}" style="display:block; color:inherit; text-decoration:none;" data-day="{{ d.day }}">
          <div class="day__head">
            <div class="day__title">{{ d.day }}</div>
            <div class="day__count">{{ d.count }} {{ t(request, 'home.day.mails') }}</div>
          </div>
          <div class="day__body" style="padding: 12px 14px;">
            {% if d.overview %}
              <div class="day__overview pre" style="font-size:13px; color: var(--text); border-left: 2px solid var(--accent); padding-left: 10px; margin-bottom: 10px;">{{ d.overview }}</div>
            {% endif %}
            <div class="muted" style="font-size: 12px;">{{ t(request, 'home.day.open_hint') }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(() => {
  const btn = document.getElementById('btn-sync');
  const bar = document.getElementById('sync-bar');
  const text = document.getElementById('sync-text');
  const logEl = document.getElementById('sync-log');
  const stepperEl = document.getElementById('sync-stepper');
  const trackEl = document.getElementById('sync-track');
  
  const resumBox = document.getElementById('resum-progress-box');
  const resumBar = document.getElementById('resum-bar');
  const resumText = document.getElementById('resum-text');
  const dayContainer = document.getElementById('day-list-container');
  const STR_MAILS = "{{ t(request, 'home.day.mails') }}";
  const STR_OPEN_HINT = "{{ t(request, 'home.day.open_hint') }}";

  if (!btn || !bar || !text) return;

  const LABEL_START = {{ t(request, 'home.btn.sync')|tojson }};
  const LABEL_STOP = {{ t(request, 'home.btn.sync_stop')|tojson }};
  const STR_STARTING = {{ ("동기화를 시작합니다" if ui_lang(request) == 'ko' else "Starting sync")|tojson }};
  const STR_ERROR = {{ ("오류" if ui_lang(request) == 'ko' else "Error")|tojson }};
  const STR_EVENT_STREAM = {{ ("오류: 이벤트 스트림" if ui_lang(request) == 'ko' else "Error: event stream")|tojson }};

  let es = null;
  let resumEs = null;
  let currentJobId = "";
  let currentResumId = "";
  let dayRefreshTimer = null;

  async function refreshDayList() {
    if (!dayContainer) return;
    try {
        const res = await fetch('/api/ui/days');
        if (!res.ok) return;
        const days = await res.json();
        
        // Simple strategy: rebuild the HTML if changed to reflect counts/new days
        let html = "";
        days.forEach(d => {
            const overviewHtml = d.overview ? `<div class="day__overview pre" style="font-size:13px; color: var(--text); border-left: 2px solid var(--accent); padding-left: 10px; margin-bottom: 10px;">${d.overview}</div>` : '';
            html += `
            <a class="day" href="/day/${d.day}" style="display:block; color:inherit; text-decoration:none;" data-day="${d.day}">
              <div class="day__head">
                <div class="day__title">${d.day}</div>
                <div class="day__count">${d.count} ${STR_MAILS}</div>
              </div>
              <div class="day__body" style="padding: 12px 14px;">
                ${overviewHtml}
                <div class="muted" style="font-size: 12px;">${STR_OPEN_HINT}</div>
              </div>
            </a>`;
        });
        dayContainer.innerHTML = html;
    } catch (e) { console.error("Day refresh failed", e); }
  }

  function setProgress(pct, msg) {
    const p = Math.max(0, Math.min(100, pct));
    bar.style.width = p + '%';
    text.textContent = (msg || '...') + ' (' + p.toFixed(2) + '%)';
  }

  function watchResummarize(jobId) {
    if (!jobId || !resumBox) return;
    currentResumId = String(jobId);
    resumBox.style.display = 'block';
    if (resumEs) resumEs.close();
    resumEs = new EventSource('/api/jobs/' + jobId + '/events');
    resumEs.addEventListener('progress', (ev) => {
      const p = JSON.parse(ev.data);
      const pct = Math.max(0, Math.min(100, (Number(p.current||0)/Number(p.total||1))*100));
      if (resumBar) resumBar.style.width = pct + '%';
      if (resumText) resumText.textContent = (p.message || '...') + ' (' + pct.toFixed(2) + '%)';
      
      // Update link to date if available in p.date_key or from message
      let dk = p.date_key || "";
      if (!dk && p.message && p.message.startsWith("[")) {
         const pot = p.message.substring(1, 11);
         if (pot.length === 10 && pot[4] === "-" && pot[7] === "-") dk = pot;
      }
      if (dk) resumBox.href = "/day/" + dk;

      if (p.status === 'succeeded' || p.status === 'failed' || p.status === 'cancelled') {
        resumEs.close();
        resumEs = null;
        currentResumId = "";
        setTimeout(() => { if (resumBox) resumBox.style.display = 'none'; }, 2000);
      }
    });
  }

  function renderProgress(p) {
    if (p && p.status === 'cancel_requested') {
      bar.style.width = '100%';
      text.textContent = "{% if ui_lang(request) == 'ko' %}멈추는 중...{% else %}Stopping...{% endif %}";
      btn.disabled = true;
      if (stepperEl) stepperEl.style.display = 'none';
      return;
    }

    const total = Number(p.total || 0);
    const cur = Number(p.current || 0);
    const denom = total > 0 ? total : 1;
    const rawPct = (cur / denom) * 100;
    const pct = Math.max(0, Math.min(100, rawPct));
    const msg = (p.message || p.status || '...');
    // Show current/total to avoid "0%" confusion on large totals.
    // Round 'cur' to avoid long floating point strings
    const frac = total > 0 ? (Math.floor(cur) + '/' + total) : String(Math.floor(cur));
    bar.style.width = pct + '%';
    let pctText = pct.toFixed(2) + '%';
    if (pct === 0 && cur > 0 && total > 0) {
      pctText = '<0.01%';
    }
    text.textContent = msg + ' (' + frac + ', ' + pctText + ')';
    btn.disabled = false;

    // Update stepper
    if (stepperEl && cur > 0) {
      stepperEl.style.display = 'flex';
      const stages = ['archive', 'summarize', 'export'];
      let activeIdx = -1;
      const m = msg.toLowerCase();
      if (m.includes('아카이브') || m.includes('archive')) activeIdx = 0;
      else if (m.includes('요약') || m.includes('summarize')) activeIdx = 1;
      else if (m.includes('내보내기') || m.includes('export') || m.includes('obsidian')) activeIdx = 2;

      if (activeIdx >= 0) {
        const nodes = stepperEl.querySelectorAll('.step');
        nodes.forEach((n, idx) => {
          if (idx < activeIdx) n.setAttribute('data-state', 'completed');
          else if (idx === activeIdx) n.setAttribute('data-state', 'active');
          else n.setAttribute('data-state', 'pending');
        });
        if (trackEl) trackEl.style.width = (activeIdx * 50) + '%';
      }
    } else if (stepperEl) {
      stepperEl.style.display = 'none';
    }
  }

  function watch(jobId) {
    if (!jobId) return;
    currentJobId = String(jobId);
    if (es) {
      try { es.close(); } catch (e) {}
      es = null;
    }
    btn.textContent = LABEL_STOP;
    es = new EventSource('/api/jobs/' + jobId + '/events');
    es.addEventListener('log', (ev) => {
      try {
        const j = JSON.parse(ev.data);
        if (logEl) {
          logEl.style.display = '';
          logEl.textContent = (j.level || 'info') + ': ' + (j.text || '');
        }
      } catch (e) {}
    });
    es.addEventListener('progress', (ev) => {
      const p = JSON.parse(ev.data);
      renderProgress(p);
      
      // Start refreshing days if sync is running
      if (p.status === 'running' && !dayRefreshTimer) {
          dayRefreshTimer = setInterval(refreshDayList, 10000); // every 10s
      }

      if (p.status === 'succeeded' || p.status === 'failed' || p.status === 'cancelled') {
        if (dayRefreshTimer) { clearInterval(dayRefreshTimer); dayRefreshTimer = null; }
        try { es.close(); } catch (e) {}
        es = null;
        currentJobId = "";
        btn.textContent = LABEL_START;
        if (stepperEl) stepperEl.style.display = 'none';
        if (p.status === 'succeeded') {
          setTimeout(() => location.reload(), 400);
        }
      }
    });
    es.addEventListener('error', () => {
      setProgress(0, STR_EVENT_STREAM);
      try { es.close(); } catch (e) {}
      es = null;
      currentJobId = "";
      btn.textContent = LABEL_START;
      if (stepperEl) stepperEl.style.display = 'none';
    });
  }

  btn.addEventListener('click', async () => {
    if (currentJobId) {
      btn.disabled = true;
      text.textContent = "{% if ui_lang(request) == 'ko' %}멈추는 중...{% else %}Stopping...{% endif %}";
      const res = await fetch('/api/jobs/' + currentJobId + '/cancel', { method: 'POST' });
      if (!res.ok) {
        try {
          const j = await res.json();
          setProgress(0, STR_ERROR + ': ' + (j.error || 'failed'));
        } catch (e) {
          setProgress(0, STR_ERROR);
        }
      }
      btn.disabled = false;
      return;
    }

    btn.disabled = true;
    btn.textContent = LABEL_STOP;
    setProgress(0, STR_STARTING);
    const res = await fetch('/api/jobs/sync', { method: 'POST' });
    const j = await res.json();
    if (!res.ok) {
      setProgress(0, STR_ERROR + ': ' + (j.error || 'failed'));
      btn.disabled = false;
      btn.textContent = LABEL_START;
      return;
    }
    watch(j.job_id);
  });

  const ACTIVE_SYNC = "{{ (active.sync.id if active and active.sync else '') }}";
  const ACTIVE_RESUM = "{{ (active.resummarize.id if active and active.resummarize else '') }}";
  
  if (ACTIVE_SYNC) {
    watch(ACTIVE_SYNC);
  } else {
    btn.textContent = LABEL_START;
  }

  if (ACTIVE_RESUM) {
    watchResummarize(ACTIVE_RESUM);
  }
})();
</script>
{% endblock %}
