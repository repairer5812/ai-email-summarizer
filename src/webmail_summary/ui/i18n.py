from __future__ import annotations

from typing import Any


TRANSLATIONS: dict[str, dict[str, str]] = {
    "en": {
        "app.name": "Webmail Summary",
        "app.sub": "Local mail archive + Obsidian export",
        "nav.dashboard": "Dashboard",
        "nav.setup": "Setup",
        "footer": "Local-only (127.0.0.1). No cloud required.",
        "home.hero.title": "Inbox, distilled.",
        "home.hero.sub": "Sync -> archive originals -> summarize -> export to Obsidian (always).",
        "home.btn.sync": "Start sync",
        "home.btn.sync_stop": "Stop sync",
        "home.btn.refresh_ing": "Summarizing...",
        "home.btn.setup": "Setup",
        "home.notice.ai.title": "AI not ready.",
        "home.notice.ai.body": "Install local AI (llama.cpp + GGUF) or configure a Cloud Service in Setup.",
        "home.notice.ai.backend": "Current backend:",
        "home.notice.saved.title": "Saved.",
        "home.notice.saved.body": "Your settings were saved.",
        "home.card.progress": "Sync progress",
        "home.day.mails": "mails",
        "home.day.open_hint": "Open to see summaries for that day.",
        "home.row.view": "View",
        "setup.title": "Setup",
        "setup.desc": "Test IMAP, pick folder, set Obsidian export path, install local AI (llama.cpp + GGUF) or configure a Cloud Service.",
        "setup.imap.card": "1) IMAP Connection Test",
        "setup.imap.ok": "IMAP OK. Folders loaded.",
        "setup.imap.fail": "IMAP failed:",
        "setup.imap.host": "IMAP host",
        "setup.imap.port": "IMAP port (SSL)",
        "setup.imap.user": "User (email)",
        "setup.imap.password": "Password",
        "setup.imap.test": "Test & Load Folders",
        "setup.save.card": "2) Save Settings",
        "setup.ai.not_ready.title": "AI is not ready.",
        "setup.ai.not_ready.body": "This app is AI-first. Install local AI or set a Cloud API key to enable sync.",
        "setup.imap.folder": "IMAP folder",
        "setup.imap.folder.tip": 'Tip: click "Test & Load Folders" first to pick from a list.',
        "setup.sender_filter": "Sender filter",
        "setup.sender_filter.help": "Default: hslee@tekville.com",
        "setup.obsidian_root": "Obsidian export root",
        "setup.pick": "Pick",
        "setup.obsidian_root.help": "Default: Desktop\\Tekville_Obsidian",
        "setup.ui_theme": "UI 테마 선택",
        "setup.ui_theme.trust": "Trust",
        "setup.ui_theme.creative": "Creative",
        "setup.external_limit": "External download limit",
        "setup.external_limit.help": "Choose a limit. Default: 1GB.",
        "setup.revert_seen": "Testing: revert read flag",
        "setup.revert_seen.label": "After sync, set those mails back to Unread",
        "setup.revert_seen.help": "For testing only. If you read a mail in another app during sync, it may get set back to Unread.",
        "setup.local_ai.card": "Local AI (llama.cpp + GGUF)",
        "setup.ctx_help": "Context window size. Larger can remember more text but costs more RAM and can be slower.",
        "setup.llm_backend": "LLM backend",
        "setup.llm_backend.help": "Recommended: Local for most users. Cloud as fallback.",
        "setup.backend.local": "Local (llama.cpp)",
        "setup.backend.openrouter": "Cloud Service (API Key)",
        "setup.wizard.prev": "Previous",
        "setup.wizard.next": "Save & Next",
        "setup.wizard.done": "Save & Finish",
        "setup.tab.profile": "1. User Profile",
        "setup.tab.connection": "2. Mail Sync",
        "setup.tab.ai": "3. AI Configuration",
        "setup.tab.advanced": "4. Advanced",
        "setup.profile.roles": "What is your job role?",
        "setup.profile.roles.help": "Multiple selections allowed. This helps AI tailor your summaries.",
        "setup.profile.interests": "Specific interests or keywords",
        "setup.profile.interests.help": "Tell us more about what you want to see in summaries (e.g., 'Latest AI news', 'Stock market').",
        "role.management": "Management",
        "role.hr": "HR",
        "role.finance": "Finance",
        "role.developer": "Developer",
        "role.marketing": "Marketing",
        "role.sales": "Sales",
        "role.planning": "Planning",
        "role.design": "Design",
        "role.legal": "Legal",
        "role.cs": "Customer Support",
        "role.research": "Research",
        "role.education": "Education",
        "setup.local_tier": "Local model tier",
        "setup.local_tier.help": "Downloads from HuggingFace. This can be multiple GB.",
        "setup.install_local": "Install local AI",
        "setup.install_btn": "Install engine + model",
        "setup.install_help": "Shows progress with %.",
        "setup.install_progress": "Install progress",
        "setup.openrouter_model": "OpenRouter model",
        "setup.openrouter_model.help": "Example: openai/gpt-4o-mini",
        "setup.openrouter_key": "OpenRouter API key",
        "setup.openrouter_key.help": "Stored in Windows Credential Manager via keyring. Not saved to SQLite.",
        "setup.save": "Save",
        "detail.summary": "Core / Detailed Summary",
        "detail.no_summary": "(no summary)",
        "detail.original": "Original",
        "detail.view_original": "View original email",
        "detail.no_rendered": "No rendered HTML available for this message.",
        "detail.back": "Back",
        "day.subtitle": "Messages on",
        "day.back": "Back",
        "day.open_detail": "Details",
    },
    "ko": {
        "app.name": "웹메일 요약",
        "app.sub": "로컬 메일 아카이브 + Obsidian 내보내기",
        "nav.dashboard": "대시보드",
        "nav.setup": "설정",
        "footer": "로컬 전용(127.0.0.1). 클라우드 없이 동작합니다.",
        "home.hero.title": "받은메일함, 정리된 형태로.",
        "home.hero.sub": "동기화 → 원문 아카이브 → 요약 → Obsidian 내보내기(항상 생성)",
        "home.btn.sync": "동기화 시작",
        "home.btn.sync_stop": "동기화 멈춤",
        "home.btn.refresh_ing": "요약 중...",
        "home.btn.setup": "설정",
        "home.btn.refresh_overviews": "날짜별요약",
        "home.notice.ai.title": "AI가 준비되지 않았습니다.",
        "home.notice.ai.body": "설정에서 로컬 AI(llama.cpp + GGUF)를 설치하거나 클라우드 서비스를 설정하세요.",
        "home.notice.ai.backend": "현재 백엔드:",
        "home.notice.saved.title": "저장되었습니다.",
        "home.notice.saved.body": "설정이 저장되어 대시보드로 이동했습니다.",
        "home.card.progress": "동기화 진행률",
        "home.day.mails": "건",
        "home.day.open_hint": "클릭하면 해당 날짜의 요약 목록을 봅니다.",
        "home.row.view": "보기",
        "setup.title": "설정",
        "setup.desc": "IMAP 테스트, 폴더 선택, Obsidian 경로 지정, 로컬 AI(llama.cpp + GGUF) 설치 또는 클라우드 서비스를 설정을 합니다.",
        "setup.imap.card": "1) IMAP 연결 테스트",
        "setup.imap.ok": "IMAP 연결 OK. 폴더 목록을 불러왔습니다.",
        "setup.imap.fail": "IMAP 실패:",
        "setup.imap.host": "IMAP 호스트",
        "setup.imap.port": "IMAP 포트(SSL)",
        "setup.imap.user": "사용자(이메일)",
        "setup.imap.password": "비밀번호",
        "setup.imap.test": "테스트 & 폴더 불러오기",
        "setup.save.card": "2) 설정 저장",
        "setup.ai.not_ready.title": "AI가 준비되지 않았습니다.",
        "setup.ai.not_ready.body": "이 앱은 AI 중심입니다. 로컬 AI를 설치하거나 클라우드 API 키를 설정해야 동기화가 활성화됩니다.",
        "setup.imap.folder": "IMAP 폴더",
        "setup.imap.folder.tip": '팁: 먼저 "테스트 & 폴더 불러오기"를 눌러 목록에서 선택하세요.',
        "setup.sender_filter": "발신자 필터",
        "setup.sender_filter.help": "기본값: hslee@tekville.com",
        "setup.obsidian_root": "Obsidian 내보내기 경로",
        "setup.pick": "선택",
        "setup.obsidian_root.help": "기본값: Desktop\\Tekville_Obsidian",
        "setup.ui_theme": "UI 테마 선택",
        "setup.ui_theme.trust": "Trust",
        "setup.ui_theme.creative": "Creative",
        "setup.external_limit": "외부 리소스 다운로드 제한",
        "setup.external_limit.help": "다운로드 최대 용량을 선택하세요. 기본값: 1GB.",
        "setup.revert_seen": "테스트: 읽음 원복",
        "setup.revert_seen.label": "Sync가 끝나면 다시 안읽음으로 돌리기",
        "setup.revert_seen.help": "테스트할 때만 켜세요. 동기화 중 다른 앱에서 읽은 메일도 마지막에 안읽음으로 돌아갈 수 있어요.",
        "setup.local_ai.card": "로컬 AI (llama.cpp + GGUF)",
        "setup.ctx_help": "ctx-size(컨텍스트 크기)는 모델이 한 번에 참고할 수 있는 텍스트 길이입니다. 크면 더 많이 기억하지만 RAM을 더 쓰고 느려질 수 있어요.",
        "setup.llm_backend": "LLM 백엔드",
        "setup.llm_backend.help": "권장: 대부분 로컬 사용. 클라우드를 fallback으로.",
        "setup.backend.local": "로컬(llama.cpp)",
        "setup.backend.openrouter": "클라우드 서비스 (API Key)",
        "setup.wizard.prev": "이전",
        "setup.wizard.next": "저장 및 다음",
        "setup.wizard.done": "저장 및 완료",
        "setup.tab.profile": "1. 내 프로필",
        "setup.tab.connection": "2. 메일 연결",
        "setup.tab.ai": "3. AI 설정",
        "setup.tab.advanced": "4. 고급 설정",
        "setup.profile.roles": "현재 하시는 직무는 무엇인가요?",
        "setup.profile.roles.help": "복수 선택이 가능합니다. 선택하신 직무에 맞춰 요약이 제공됩니다.",
        "setup.profile.interests": "특별히 관심 있는 분야나 키워드가 있나요?",
        "setup.profile.interests.help": "더 구체적으로 알고 싶은 내용을 적어주세요. (예: 최신 AI 뉴스, 주식 시장 등)",
        "role.management": "경영",
        "role.hr": "인사",
        "role.finance": "재무",
        "role.developer": "개발",
        "role.marketing": "마케팅",
        "role.sales": "영업",
        "role.planning": "기획",
        "role.design": "디자인",
        "role.legal": "법무",
        "role.cs": "고객지원",
        "role.research": "연구/R&D",
        "role.education": "교육",
        "setup.local_tier": "로컬 모델 티어",
        "setup.local_tier.help": "HuggingFace에서 다운로드합니다. 수 GB가 될 수 있습니다.",
        "setup.install_local": "로컬 AI 설치",
        "setup.install_btn": "엔진 + 모델 설치",
        "setup.install_help": "%로 진행률을 표시합니다.",
        "setup.install_progress": "설치 진행률",
        "setup.openrouter_model": "OpenRouter 모델",
        "setup.openrouter_model.help": "예: openai/gpt-4o-mini",
        "setup.openrouter_key": "OpenRouter API 키",
        "setup.openrouter_key.help": "Windows 자격 증명 관리자(keyring)에 저장됩니다. SQLite에는 저장하지 않습니다.",
        "setup.save": "저장",
        "detail.summary": "핵심 요약 / 상세 요약",
        "detail.no_summary": "(요약 없음)",
        "detail.original": "원문",
        "detail.view_original": "이메일 원본 보기",
        "detail.no_rendered": "이 메일에 대해 렌더링된 HTML이 없습니다.",
        "detail.back": "뒤로",
        "day.subtitle": "해당 날짜 메일",
        "day.back": "대시보드",
        "day.open_detail": "상세",
    },
}


def ui_lang(request: Any | None) -> str:
    try:
        v = str(getattr(request, "cookies", {}).get("lang") or "").strip().lower()
        if v in {"ko", "en"}:
            return v
    except Exception:
        pass
    return "ko"


def t(request: Any | None, key: str) -> str:
    lang = ui_lang(request)
    return (
        TRANSLATIONS.get(lang, {}).get(key)
        or TRANSLATIONS.get("en", {}).get(key)
        or key
    )
