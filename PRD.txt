Tekville Webmail Summary PRD (v2)
작성일: 2026-02-17

1) 배경 / 문제
- 테크빌교육(주)는 다우오피스(daouoffice)를 사용한다.
- 접속 주소(참고): tekville.daouoffice.com
- 업무 메일 중 "z이형세" 메일함(공유/추가 메일함)에 대표(이형세) 발신 메일이 누적된다.
- 대표 메일은 기사/자료 공유가 잦고, 바쁜 일정 때문에 매일 전부 읽기 어렵다.
- 개인적인 메일이 섞일 수 있어 요약만 보지 말고 원문 확인이 가능해야 한다.

2) 제품 목표(What)
- 윈도우 데스크탑(Windows 10/11)에서 동작하는 로컬 앱(배포형)으로, 다우오피스 메일을 수집/아카이빙하고 요약/분류하여 GUI로 제공한다.
- Obsidian을 쓰는 사용자를 위해, Obsidian 호환 Markdown(태그 + 백링크 포함)을 "항상" 생성한다(필수).
- Obsidian을 사용하지 않는 사용자도, 앱 내 GUI에서 날짜별/주제별로 요약본을 모아보고 메일 원문(이미지/영상 포함)을 확인할 수 있어야 한다.

3) 핵심 요구사항(Functional)

3.1 GUI(필수) + FastAPI 기반
- 모든 기본 메뉴는 GUI로 동작해야 한다(터미널 사용 최소화).
- 구현 방식: FastAPI로 로컬 서버(127.0.0.1) + 웹 UI.
- UI는 "세련된" 디자인을 목표로 한다.
  - 가능하면 Next.js를 개발에 활용할 수 있으나, 배포 시 Node 런타임이 없어도 동작하도록 구성하는 것을 우선한다.
  - 우선순위: 배포/유지보수 단순성 > 프론트 기술 스택의 화려함.

3.1.1 프론트엔드 구현 권장안(배포 고려)
- 권장: Next.js를 "정적 export"로 빌드하여 산출물(out 디렉토리)을 FastAPI가 정적 파일로 서빙한다.
  - 장점: 사용자 PC에 Node.js가 없어도 동작(배포 단순).
  - 주의: Next.js Image Optimization 등 서버 의존 기능은 정적 export와 충돌할 수 있다.
- 대안(단순/경량): FastAPI + Jinja2 템플릿 + HTMX로 UI 구현(파이썬만으로 빌드/배포).
- 보안: 로컬 서버는 반드시 127.0.0.1로만 바인딩한다.
- UX: 앱 실행 시 기본 브라우저를 자동으로 열어준다(예: http://127.0.0.1:<port>/).

3.2 초기 설정(Setup Wizard)
- 사용자가 GUI에서 다음을 입력/선택한다:
  - IMAP host/port/user/password
  - IMAP 폴더 목록을 서버에서 가져와(로그인 성공 후) 사용자가 선택
  - 대표 발신자 필터는 객관식 제공:
    - 기본: hslee@tekville.com
    - 기타: 직접 입력
  - Obsidian 저장 경로 선택(폴더 선택 UI)
    - 기본값: 바탕화면\Tekville_Obsidian
    - 사용자가 원하면 변경 가능
  - 자동 실행(윈도우 로그인 시 실행) On/Off
  - 로컬 LLM 사용 On/Off 및 모델 선택(기본값 제공)

3.2.2 로컬 LLM 설치 UX(필수)
- 사용자가 GUI에서 로컬 LLM 모델(저/중/고)을 선택하면 앱이 자동으로 설치(다운로드)한다.
- 설치 진행 상황을 다음 형태로 표시한다:
  - Progress bar
  - 퍼센트(%)
  - (가능하면) 다운로드된 용량/총 용량
- 설치 중에도 UI가 멈추지 않아야 한다(백그라운드 작업 + 진행률 스트리밍).

3.2.1 설정 기본값(첨부된 다우오피스 외부 메일 앱 안내 기준)
- IMAP host 기본값: imap.daouoffice.com
- IMAP port 기본값: 993 (SSL)
- (참고) POP3 host: pop3.daouoffice.com
- (참고) SMTP host 후보: outbound.daouoffice.com / send.daouoffice.com
- 실제 테넌트/정책에 따라 host가 다를 수 있으니, 사용자 설정 화면의 값을 우선한다.

3.3 메일 수집/동기화(IMAP 우선)
- 프로토콜: IMAP(SSL) 기반 수집(웹 UI 크롤링은 예외적 fallback).
- 수집 단위: 이메일 1건씩
- 필터:
  - 발신자(기본: hslee@tekville.com)
  - 날짜(기본: 최근 N일 또는 마지막 처리 이후)
- "읽음 처리"(중요):
  - 아카이빙 + DB 저장 + Markdown 생성까지 모두 성공한 메일만 서버에 \Seen(읽음) 처리한다.
  - \Seen이 웹 UI에 반영되지 않는 특수 케이스가 발생하면, 별도 옵션으로 웹 UI 자동화(Playwright)로 읽음 처리 fallback을 제공한다.

3.4 원본 아카이빙(필수: 오프라인 열람 가능)
- 각 메일에 대해 다음을 로컬에 저장한다:
  - raw 원본(.eml): RFC822 전체 저장
  - 본문 HTML/텍스트(가능하면 둘 다)
  - 첨부파일(이미지/영상/문서 등) 저장
- HTML 본문에 포함된 리소스 처리:
  - cid: 인라인 이미지는 저장된 첨부파일로 치환
  - 외부 URL로 박힌 이미지/영상/CSS 리소스도 다운로드한다(요구사항). 개인정보/추적 리스크는 허용한다.
  - 다운로드 후, HTML을 로컬 파일 참조로 rewrite해서 오프라인에서도 동일하게 보이도록 한다.

3.4.1 외부 리소스 다운로드 범위(권장)
- HTML에서 다음 위치들을 탐지하여 다운로드 대상으로 본다(대표 케이스):
  - <img src="...">, <source src="...">, <video src="...">, <audio src="...">, <iframe src="...">(옵션)
  - <link rel="stylesheet" href="...">, <link rel="icon" href="...">(옵션)
  - style 속성/태그 내 url(...) (예: background-image)
- 다운로드 후, HTML의 URL을 로컬 상대경로로 치환한다.
- 구현은 정규식만으로 처리하지 말고 HTML 파서(예: BeautifulSoup/lxml 계열) 기반으로 한다.
- 대용량 파일 대비:
  - 기본 최대 다운로드 용량은 1GB로 한다(설정 가능).
  - 초과 시 "링크만 저장" + GUI/MD에 표시한다.

3.5 요약/태그/주제 분류(이메일 1건 단위)
- 각 이메일을 1건씩 분석하여 다음을 생성한다:
  - 요약(짧게)
  - 핵심 키워드
  - 태그(tag)
  - 주제(카테고리)
  - 개인 메일 여부(플래그)
- 분류 방식:
  - 누적 데이터를 바탕으로 "주제 후보 3~7개"를 제안하고, 사용자가 확정/수정할 수 있게 한다.
  - 월 1회 정도, 누적 데이터를 기반으로 주제 후보를 재제안(재클러스터링)한다.

3.6 날짜별/주제별 모아보기(필수)
- 앱 UI에서 다음 화면을 제공한다:
  - 날짜별(Daily): 하루에 수집된 메일 리스트 + "그날의 요약"(Daily Digest)
  - 주제별(Topics): 주제/태그별 메일 모아보기
  - 메일 상세(Detail): 요약 + 원문(HTML/텍스트) + 첨부/외부 리소스 보기

3.7 Obsidian Markdown 내보내기(필수)
- Obsidian 사용 여부와 관계 없이, 기본적으로 Markdown 파일을 생성한다.
- 파일은 사용자가 지정한 폴더(기본: 바탕화면\Tekville_Obsidian)에 저장한다.
- 각 이메일에 대해 "요약본+원본 접근"이 가능한 md를 생성해야 한다.
- 반드시 포함:
  - tag 처리(Obsidian에서 탐색 가능)
  - backlink 처리(주제 노트/날짜 노트로 위키링크)
- 생성 파일 유형(권장):
  - 메일 1건당 1개 md
  - 날짜별 Daily Digest md
  - 주제별 Index md(선택 또는 자동)

4) 데이터 저장(필수)

4.1 SQLite(필수)
- GUI에서 날짜/주제/검색을 빠르게 제공하기 위해 SQLite를 사용한다.
- md 파일은 별도로 반드시 생성한다(요구사항).

권장 테이블(초안):
- emails(id, message_id, imap_uid, folder, from, to, subject, date, received_at, flags, raw_eml_path, html_path, text_path, summary, personal, created_at)
- attachments(id, email_id, filename, mime_type, size_bytes, path, content_id, is_inline)
- external_assets(id, email_id, original_url, local_path, mime_type, size_bytes, status)
- tags(id, name)
- email_tags(email_id, tag_id)
- topics(id, name)
- email_topics(email_id, topic_id)
- daily_digests(date, folder, sender_filter, summary, md_path)

4.2 파일/폴더 레이아웃(권장)
- Obsidian export root (기본): Desktop\Tekville_Obsidian
  - Mail\YYYY-MM\YYYY-MM-DD - <subject>.md
  - Daily\YYYY-MM-DD.md
  - Topic\<topic>.md
  - Assets\<email_id>\attachments\...
  - Assets\<email_id>\external\...
  - Raw\<email_id>.eml

5) AI / LLM 요구사항
- AI 기능(요약/태그/주제)은 핵심 기능이다.
- 로컬 LLM을 기본으로 제공한다.
  - HuggingFace에서 GGUF 모델을 다운로드하고, 로컬 런타임(llama.cpp)을 통해 실행한다.
  - GUI에서 저/중/고 3가지 로컬 모델 중 1개를 선택하여 설치할 수 있어야 한다(진행률 bar + %).
- 클라우드 LLM은 개별 Provider 직접 연동(OpenAI/Google/Claude/Upstage 등)을 하지 않고, OpenRouter로 통합한다(옵션 fallback).

5.1 로컬 LLM 모델 3종(초안)
5.1 로컬 LLM(필수)

로컬 런타임
- llama.cpp (Windows binary) 사용
- 엔진/모델은 앱이 자동 다운로드/설치할 수 있어야 한다(진행률 표시)

모델 3종(Option B, GGUF)
- Low: bartowski/Qwen2.5-3B-Instruct-GGUF
  - 파일: Qwen2.5-3B-Instruct-Q4_K_M.gguf
- Medium (Korean 강화): bartowski/EXAONE-3.5-7.8B-Instruct-GGUF
  - 파일: EXAONE-3.5-7.8B-Instruct-Q4_K_M.gguf
- High: bartowski/Qwen2.5-14B-Instruct-GGUF
  - 파일: Qwen2.5-14B-Instruct-Q3_K_S.gguf

저장 위치(권장)
- %LOCALAPPDATA%\\WebmailSummary\\models\\gguf\\...

추천 로직(초안)
- RAM < 20GB: Low
- 20GB <= RAM < 28GB: Medium
- RAM >= 28GB: High

5.2 OpenRouter(클라우드 통합, 옵션 fallback)
- 엔드포인트: https://openrouter.ai/api/v1/chat/completions
- 헤더: Authorization Bearer <key>
- GUI에서 OpenRouter API key를 설정할 수 있어야 한다(키는 OS 보안 저장소에 저장).
- 모델 선택은 OpenRouter model id 문자열로 지정한다(예: openai/gpt-4o-mini).

6) 보안 / 설정
- 사용자 계정 정보(id/pw)는 로컬에 안전하게 저장한다.
  - 기본: 윈도우 자격 증명 관리자(또는 동급 보안 저장소) 사용.
- PRD/소스코드/로그에 비밀번호를 절대 하드코딩/기록하지 않는다.

6.1 HTML 표시 안전성(필수)
- 메일 원문 HTML을 GUI에서 보여줄 때 스크립트가 실행되면 안 된다.
  - 예: <script> 제거, on* 이벤트 제거, iframe 제한 등
- 외부 리소스는 "다운로드 후 로컬 파일"을 사용하도록 rewrite한다.

7) 배포(윈도우)
- 개발 완료 후 일반 사용자에게 배포하여 각자 PC(윈도우)에서 실행 가능해야 한다.
- 설치/실행이 쉬워야 한다(초보자 대상).
- 자동 실행은 옵션으로 제공(윈도우 로그인 시 실행).

7.1 배포 산출물(권장)
- 단일 실행 파일(.exe) 또는 설치 프로그램 형태를 목표로 한다.
- 프론트엔드가 Next.js인 경우, 빌드 산출물(out)을 exe에 포함하여 FastAPI가 함께 서빙한다.

8) 범위 제외(Non-goals, v2 기준)
- 메일 발송 기능(아웃바운드)
- 완전한 이메일 클라이언트(규칙/필터/서명/회신 등)
- 모바일 앱
- Flutter 기반 구현(이번 범위 제외)

9) 성공 기준(Acceptance Criteria)
- GUI만으로 설정을 끝낼 수 있다.
- 메일 1건을 아카이빙(원문+첨부+외부 리소스)하고, 요약+태그+주제를 생성한다.
- 처리 성공한 메일은 IMAP에서 읽음 처리(\Seen)된다.
- 날짜별/주제별 화면에서 요약본을 모아볼 수 있고, 메일 상세에서 원문을 볼 수 있다.
- Obsidian용 md가 기본 경로(Desktop\Tekville_Obsidian)에 생성되며, 태그/백링크가 동작한다.
