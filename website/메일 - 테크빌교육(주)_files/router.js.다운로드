(function(){var e=this;define(["backbone","app","json!configs/routes.json","json!configs/routes.custom.json","admin/collections/side_menu_collection","backbone.routefilter","../libs/go-google-analytics","jquery.cookie"],function(t,n,r,i,s){function h(){var e=n.config("instanceType"),t=document.getElementsByTagName("meta"),r;for(var i in t)t[i].name==="device"&&(r=t[i].content);return n.config("instanceType")!=="app"?e=n.config("instanceType"):r&&r==="mobile"&&$.cookie("pcVersion")==="true"?e="app":r==="pc"?e="app":r==="tablet"?$.cookie("pcVersion")==="true"?e="app":e="mobile":r==="mobile"&&(e=r),e}function d(e){var t=n.config("googleAnalyticsOption"),r=e,i=e.substr(0,1);i!="/"&&(r="/"+r);if(!_.isObject(t)||!t.trackerId)return;n.Analytics.excute(t,r)}var o,u=null,a=new RegExp("^([a-zA-Z0-9/=_-]*:)+(.*)$"),f=Array.prototype.slice,l,c;n.fetch("baseConfig").done(function(){o=n.config("packages"),l="("+["my","sitelink",o.join("|")].join("|")+")",c=h()});var p=t.Router.extend({initialize:function(){this._generateFromRoutes()},navigate:function(e,r){return n.util.purgeMailAndWebFolder(),this.getPackageName()!=="home"&&(t.history.fragment=null),d(e),t.Router.prototype.navigate.call(this,e,r)},before:function(e){this._clearContentViewer(),this._clearDatepikcer(),this._clearEditor(),this._parseFragment(),this._clearDocumentEvent(),this._renewalPaginatedParam(),this.trigger("beforeNavigate")},after:function(){n.util.pageDone&&n.util.pageDone(location.href)},getPackageName:function(){return u},setPackageName:function(e){u!==e?(u=e,this.trigger("change:package",u)):this.trigger("change:page",u)},getRootUrl:function(){var t=null;return e.location&&(t=e.location.protocol+"//"+e.location.host+n.config("root")),t},getSendMailUrl:function(t){var n=null,r=null;typeof t=="object"?(r=$.grep([t.name,t.position,t.department],function(e,t){return e!==""&&e!==undefined}),r.length?r=r.join("/"):r="",r+=" <"+t.email+">"):r=t;var i={to:r};return e.location&&(n=this.getRootUrl()+"mail/popup/process?data="+encodeURIComponent(JSON.stringify(i))),n},getUrl:function(e){var t=this.getRootUrl(),e=e||location.href;return this.isEqualToRootUrl(e)?e.slice(t.length):e},getSearch:function(t){var n=/[\?](.*)?/,r=e.location.search||e.location.hash,i=n.exec(r),s={};return n.test(r)&&i[1]!=null&&_.each(i[1].split("&"),function(e,t){var n=(e.indexOf("%5B%5D")||e.indexOf("[]"))>0,r=e.split("=");if(n){var i=decodeURIComponent(e).split("[]")[0],o=s[i]||[];s[i]=_.union(o,[decodeURIComponent(r[1])])}else s[r[0]]=decodeURIComponent(r[1])},this),typeof t!="undefined"?s[t]:s},isEqualToRootUrl:function(e){var t=this.getRootUrl();return e.slice(0,t.length)===t},_clearDatepikcer:function(){$("div.ui-datepicker").hide()},_clearEditor:function(){n.Editor&&n.Editor.destroyAll()},_parseFragment:function(){var e=t.history.getFragment(),n=this._generateRegExpFromStr("[!/]*"+l),r=e.match(n);r&&r[1]?this.setPackageName(r[1]):this.setPackageName(null)},_generateFromRoutes:function(){console.log("========== generateFromRoutes =========="),this._filterUnauthorizedAdminRoutes();var e=$.extend(!0,{},r,i);_.each(e[c],function(e,t){var n=/^exp:/,r=n.test(t)?this._generateRegExpFromStr(t):t+"*search";this._processAction(e,r)},this),n.routes=r,n.routes.hasRouteAuth=function(e,t){return _.any(r,function(n,r){return e!=r?!1:_.any(n,function(e,n){return e=="admin.error.page403"?!1:t==n})})}},_filterUnauthorizedAdminRoutes:function(){if(n.instanceType!="admin"){delete r.admin,delete i.admin;return}var e=new s;_.forEach(r.admin,function(t,n){if(t=="admin.main.renderCompanyInfo")return;e.isAuthorizedRoutingPath(t)||(r.admin[n]="admin.error.page403")}),_.forEach(i.admin,function(t,n){e.isAuthorizedRoutingPath(t)||(i.admin[n]="admin.error.page403")})},_processAction:function(e,t){if(!this._processDirectiveAction(e,t)){var n=e.split(".");if(n.length!=3)throw new Error("Illegal action name");this.route(t,e,function(){var e=f.call(arguments),t=n[0],r=n[1],i=n[2],s=(t==="core"?"":t+"/")+"controllers"+"/"+r;require([s],function(t){if(!t[i])throw new Error("Action: "+i+" is not exists!!");t[i].apply(t,e)})})}},_processDirectiveAction:function(e,t){var r=e.match(a);return!r||r.length<2?!1:(this.route(t,e,function(){if(r[1]==="redirect:"){if(r[2]=="mail/"||r[2]=="webfolder/")return window.location=this.getRootUrl()+r[2],!0;if(r[2]=="home/"){var e=n.util.getInitMenu();r[2]=e?e.appName:r[2]}return this.navigate(r[2],{trigger:!0,replace:!0})}}),!0)},_generateRegExpFromStr:function(e){var t=null,r=/\/?([g|i|m]*)$/,i=e.match(r)[1],s=e.replace(/^exp:/,"").replace(/^\//,"").replace(/^\^/,"").replace(r,""),o="!/",u=new RegExp("^"+o);return n.config("useHashbang")&&!u.test(s)&&(s=o+s),s="^"+s+"([?]{1}.*)?",i?t=new RegExp(s,i):t=new RegExp(s),t},_clearDocumentEvent:function(){$(document).off("click.backdrop"),$(document).off("backdrop"),$(document).on("click.backdrop",$.proxy(function(e){$(document).trigger($.Event("backdrop",{relatedTarget:e.target}))},this))},_renewalPaginatedParam:function(){n.fetch("session").done(function(){var e=n.util.store.get(n.session("id")+"-storedParam-cycle2")||null,t=n.util.store.get(n.session("id")+"-storedParam-cycle3")||null;n.util.store.set(n.session("id")+"-storedParam-cycle1",e,{type:"session"}),n.util.store.set(n.session("id")+"-storedParam-cycle2",t,{type:"session"}),n.util.store.set(n.session("id")+"-storedParam-cycle3",null,{type:"session"})})},_clearContentViewer:function(){var e=$("iframe[el-content-viewer]").contents().find("embed");n.util.msie()&&e.length&&(e.hide().remove(),n.util.isIE8()&&window.location.reload())}},{__instance__:null,getInstance:function(){return this.__instance__||(this.__instance__=new p),this.__instance__},route:function(e,t){var n=this.getInstance();n.route(e,e,t)},group:function(e,t){if(h()!==e)return;t.call(this)}});return n.fetch("baseConfig").done(function(){n.router=p.getInstance()}),p})}).call(this);