(function(e,t,n,r,i){function d(e){this.options=e,this.isWinFocused=!0,this.init()}function v(n,r,i){this.boshUrl=n,this.auth=r,this.options=e.extend(!0,{},v.options,i),this.msgQueue=[],this.isPause=!1,this.delegateEvents(),this.notiFactory=new d({timeout:this.options.timeout}),this.boshConn=new t.Connection(this.boshUrl)}var s="web-noti:closed",o=0,u=5,a="ko",f=e('meta[name="locale"]').attr("content")||a,l={ko:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4."},ja:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"\u78ba\u8a8d\u3055\u308c\u3066\u306a\u3044\u901a\u77e5{{arg1}}\u4ef6\u304c\u3042\u308a\u307e\u3059\u3002"},en:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"There is {{arg1}} notifications."},zh_CN:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"\u6709{{arg1}}\u4ef6\u901a\u77e5\u6ca1\u6709\u67e5\u770b\u3002"},zh_TW:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"\u6709{{arg1}}\u4ef6\u901a\u77e5\u6c92\u6709\u67e5\u770b\u3002"},vi:{"\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4.":"C\u00f3 {{arg1}} th\u00f4ng b\u00e1o ch\u01b0a \u0111\u01b0\u1ee3c x\u00e1c nh\u1eadn."}},c=function(e,t,n){var r=Hogan.compile(e),i={};return typeof t=="object"?i=t:i[t]=n,r.render(i)},h=function(){function t(t,n){this.model=t,this.options=e.extend({timeout:1e4},n),this.index=e(".web-noti-wrap").length,this.$el=e('<div class="noti_wrap web-noti-wrap"></div>').css("z-index","9999"),this.$el.data("instance",this),this._buildLayer()}function n(){var e=[];return e.push('<ul class="type_simple_list simple_list_alarm">'),e.push("<li>"),e.push('<p class="type"><span class="ic_gnb"></span></p>'),e.push('<p class="photo"><img src=""></span></p>'),e.push('<div class="info">'),e.push('<p class="subject">'),e.push('<a href="" data-bypass class="msg"></a>'),e.push("</p>"),e.push("</div>"),e.push("</li>"),e.push("</ul>"),e.push('<a class="btn_layer_x"><span class="ic"></span><span class="txt">close</span></a>'),e.join("\n")}function i(e){var t=e.match(/^[\[][^\]]*[\]]*/);return t?(contents=e.split(t)[1],'<strong class="type">'+t+'</strong><span class="cont">'+contents+"</span>"):e}return t.prototype={render:function(){setTimeout(e.proxy(this.close,this),this.options.timeout),this.delegateEvents(),this.$el.appendTo("body"),this.setPosition()},setPosition:function(){var e=this.$el.outerHeight()*this.index+u;this.$el.css("bottom",e+"px")},delegateEvents:function(){this.$el.on("click","li",e.proxy(function(t){t.preventDefault(),e(r).trigger("web-noti:confirm",[this])},this)),this.$el.on("click","a.btn_layer_x",e.proxy(function(e){e.preventDefault(),this.close()},this))},getIndex:function(){return this.index},reposition:function(){var e=this.$el.outerHeight();this.index=this.index-1,this.$el.animate({bottom:"-="+e},150)},undelegateEvents:function(){this.$el.off()},remove:function(){this.undelegateEvents(),this.$el.remove(),o--},close:function(){this.$el.fadeOut(500,e.proxy(function(){var t=this;e(r).trigger(s,[this.getIndex(),function(){t.remove()}])},this))},_buildLayer:function(){this.$el.append(n()),this._setIconType(),this._setProfile(),this._setMsg()},_setIconType:function(){var e={mail:"mail",calendar:"cal",bbs:"bbs",community:"comm",task:"task",approval:"approval",addr:"contact",survey:"survey",report:"report",todo:"todo",alarm:"alarm",works:"works",docs:"docs",asset:"asset",webfolder:"file",ehr:"ehr",channel:"alarm",manager:"task"};this.model.category&&e[this.model.category.toLowerCase()]&&this.$el.find(".ic_gnb").addClass("ic_type2_"+e[this.model.category.toLowerCase()])},_setProfile:function(){this.$el.find(".photo > img").attr("src",this.model.profile).attr("title",this.model.sender||"")},_setMsg:function(){this.$el.find("a.msg").html('<strong class="type">'+this._escapeHtml(this.model.sender||"")+'</strong><span class="cont">'+this._escapeHtml(this.model.message)+"</span>")},_escapeHtml:function(e){return e?(e=e.replace(/</gi,"&lt;"),e=e.replace(/>/gi,"&gt;"),e=e.replace(/(\n)/gi,"<br>"),e=e.replace(/ /gi,"&nbsp;"),e):e}},t}(),p=function(){function e(e){this.model=e}function t(){return!!n.webkitNotifications}function r(){return t()&&n.webkitNotifications.checkPermission()===0}return e.prototype={render:function(){var e=this;if(r()){var t=n.webkitNotifications.createNotification(e.model.profile,e.model.category,e.model.message);t.onclick=function(){n.location.href=e.model.linkUrl,t.close()},t.show()}}},e.isSupported=t,e.hasPermission=r,e}();return d.prototype={init:function(){var t=this;e(n).focus(function(){t.isWinFocused=!0}),e(n).blur(function(){t.isWinFocused=!1})},getNotiInstance:function(e){return p.hasPermission()?Klass=this.isWinFocused?h:p:Klass=h,new Klass(e,this.options)},render:function(e){this.getNotiInstance(e).render()},renderQueuedNoti:function(e){var t={linkUrl:"/app/noti/unread",category:"alarm",message:c(l[f]["\ud655\uc778\ub418\uc9c0 \uc54a\uc740 \uc54c\ub9bc {{arg1}}\uac74\uc774 \uc788\uc2b5\ub2c8\ub2e4."],{arg1:e.length}),profile:"/resources/images/photo_profile_small.jpg"};return this.render(t)}},v.prototype={run:function(){this._connectXmppServer()},delegateEvents:function(){var t=this;e(r).on(s,e.proxy(function(t,n,r){this.popup(),e(".noti_wrap").each(function(t,r){var i=e(r).data("instance"),s=i.getIndex();s>+n&&i.reposition()}),r()},this)),e(r).on("showActiveX.editor",function(){t.isPause=!0}),e(r).on("hideActiveX.editor",function(){t.isPuase=!1;if(!t.msgQueue.length)return;t.notiFactory.renderQueuedNoti(t.msgQueue),t.msgQueue=[]})},release:function(){e(r).off("goNotiClose")},popup:function(e){var t;typeof t=="undefined"&&this.msgQueue.length>0?t=this.msgQueue.shift():t=e,t&&(this.notiFactory.render(t),o++)},onMsgReceived:function(t){var n=e(t).find("body:first"),i=e.parseJSON(n.text());return i.type&&i.type==="realtime"?(e(r).trigger("noti.realtime."+i.category,[i]),!0):this.isPause?(this.msgQueue.push(i),!0):(o>=this.options.maxDisplayCounts?this.msgQueue.push(i):this.popup(i),this.options.onReceiveMessage(t),!0)},_connectXmppServer:function(){var n=this,r=this.boshConn,i=this.auth;r.connect(i.jid,i.password,function(i){i===t.Status.CONNECTED?(console.log("[ Strophe - BOSH Server ] Connnected"),r.addHandler(e.proxy(n.onMsgReceived,n),null,"message","headline"),r.send($pres())):i===t.Status.DISCONNECTED&&console.log("[ Strophe - BOSH Server ] disconnected")})},disconnect:function(){var e=this.boshConn,t=this.auth;e.disconnect(t.jid,t.password,function(e){console.log(e)})}},v.options={maxDisplayCounts:5,timeout:15e3,onReceiveMessage:function(){}},v.option=function(t,n){if(e.isPlainObject(t))this.options=e.extend(!0,this.options,t);else{if(t&&typeof n=="undefined")return this.options[t];this.options[t]=n}},n.GONotification=v,v})(jQuery,Strophe,window,document);