(function(e){e.goNodeList=function(e){if(arguments[0]==="close")return this.close();var n=new t;return n.initialize(e),n};var t=function(){var t=!1;return{treeEl:null,defaults:{keyword:null,type:"user",circle:null,selectQuery:"#memberList",callback:null,companyIds:[],parentNodeId:null,parentNodeIds:[],parentNodeType:"department",multiCompanyVisible:!1,isAdmin:!1,contextRoot:"/",isDndActive:!1,dndDropTarget:null,dropCheck:null,dropFinish:null,i18n:{},page:0,method:"GET",css:{minHeight:375,maxHeight:400,"overflow-y":"auto"}},initialize:function(t){return this.options=e.extend({},this.defaults),this.options.keyword=t.keyword,t.selectQuery&&(this.options.selectQuery=t.selectQuery),t.type&&(this.options.type=t.type),t.callback&&(this.options.callback=t.callback),t.parentNodeId&&(this.options.parentNodeId=t.parentNodeId),t.parentNodeType&&(this.options.parentNodeType=t.parentNodeType),t.parentNodeIds&&(this.options.parentNodeIds=t.parentNodeIds),t.isAdmin&&(this.options.isAdmin=t.isAdmin),t.contextRoot&&(this.options.contextRoot=t.contextRoot),t.isDndActive&&(this.options.isDndActive=t.isDndActive),t.dndDropTarget&&(this.options.dndDropTarget=t.dndDropTarget),t.dropCheck&&(this.options.dropCheck=t.dropCheck),t.dropFinish&&(this.options.dropFinish=t.dropFinish),t.dropOut&&(this.options.dropOut=t.dropOut),this.options.draggables=t.draggables||["ul.member_list > li > a","ul.department_list > li > a","ul > li > a[rel]"].join(", "),this.options.useDisableNodeStyle=_.isBoolean(t.useDisableNodeStyle)?t.useDisableNodeStyle:!1,this.options.useApprReception=_.isBoolean(t.useApprReception)?t.useApprReception:!1,this.options.useApprReference=_.isBoolean(t.useApprReference)?t.useApprReference:!1,this.options.receiveAllowType=t.receiveAllowType||"ALL",t.page&&(this.options.page=t.page),t.css&&(this.options.css=t.css),t.circle&&(this.options.circle=t.circle),t.i18n&&(this.options.i18n=t.i18n),t.isOrgServiceOn&&(this.options.isDeptUse=t.isOrgServiceOn),t.method&&(this.options.method=t.method),t.type&&(this.options.isDeleteDept=this.options.type=="deleteDept"?!0:!1),t.companyIds&&(this.options.companyIds=t.companyIds),t.multiCompanyVisible&&(this.options.multiCompanyVisible=t.multiCompanyVisible),this.depts=t.depts||[],this.userIds=t.userIds||[],this.options.isBatchAdd=t.isBatchAdd||!1,t.externalLang&&(this.options.externalLang=t.externalLang),this.options.isOnlyOneMember=t.isOnlyOneMember||!1,t.memberTypeLabel&&(this.options.memberTypeLabel=t.memberTypeLabel),this.options.isCustomType=t.isCustomType||!1,t.hideOrg&&(this.hideOrg=t.hideOrg),t.parentSelector?this.$el=e(t.parentSelector).find(this.options.selectQuery):this.$el=e(this.options.selectQuery),this.options.isAdmin&&(this.options.contextRoot=this.options.contextRoot+"ad/"),this.render(),this},render:function(){var n="",r={keyword:this.options.keyword,page:this.options.page,offset:30},i=this,s=!1;if(this.options.type=="community")n=this.options.contextRoot+"api/community/members",r.nodeId=this.options.parentNodeId,r.nodeType="community";else if(this.options.type=="domaincode")n=this.options.contextRoot+"api/organization/sort/list/domaincode",r.domainCodeIds=this.options.parentNodeIds;else if(this.options.type=="complex")n=this.options.contextRoot+"api/organization/sort/list/complex",r.domainCodeIds=this.options.parentNodeIds,r.userIds=this.userIds,r.depts=this.depts;else if(this.options.type=="circle"){var o=e.param(r);n=this.options.contextRoot+"api/org/circle/tree/search?"+o,r=JSON.stringify(this.options.circle)}else this.options.type=="org"?(n=this.options.contextRoot+"api/org/user/sort/list",r.nodeType="org"):this.options.type=="department"?(n=this.options.contextRoot+"api/organization/dept/search",this.options.multiCompanyVisible&&(r.withMultiCompany=!0)):this.options.type=="deleteDept"?(n=this.options.contextRoot+"api/deletedepts?",r.offset=20):this.options.type=="contact"?n=this.options.contextRoot+"api/contact/company/group/search?":(s=!0,n=this.options.contextRoot+"api/user/sort/list",this.options.useApprReception&&(r.useApprReception=!0),this.options.useApprReference&&(r.useApprReference=!0),this.options.parentNodeId&&(r.nodeId=this.options.parentNodeId,r.nodeType="department",this.options.parentNodeIds.length&&(r.includeDeptIds=this.options.parentNodeIds),r.scope=this.hideOrg?"none":""),this.options.multiCompanyVisible&&(r.withMultiCompany=!0),_.isEmpty(this.options.companyIds)||(r.companyIds=this.options.companyIds));this._renderContainer(),this.deferred=e.Deferred();var u=function(e){e.data&&e.data.length?(this._renderItemList(e.data),this.options.isDeptUse&&e.page.page==0&&this._renderNodeList(e.data)):e.page.page==0&&this._renderEmptyList(),this.$el.off(),this._bindMemberEvent(),this._bindDeptEvent(),this._bindDNDEvent(),this._bindScrollEvent(),this.data=e.data,this.deferred.resolve(this)};if(_.isEmpty(this.options.keyword)&&s)return;setTimeout(function(){t||(t=!0,i.ajaxCalling=e.ajax({url:n,type:i.options.method||"GET",contentType:"application/json",data:r,success:e.proxy(u,i)}).always(function(){t=!1}))},200)},abortAjaxCall:function(){this.ajaxCalling&&this.ajaxCalling.abort()},getSelectedData:function(){var t=e("a.jstree-clicked",this.$el);return t&&t.length>0?this._processSearchData(t.parent()):{}},addClassToDNDTarget:function(){this._bindDNDEvent()},_renderContainer:function(){if(this.options.page==0){var e=Hogan.compile(['<div class="jstree jstree-default" id="searchDepartmentEl" style="border-bottom:1px dashed #c8c8c8;margin:5px;display:none">','    <ul class="department_list"></ul>',"</div>",'<ul class="member_list"></ul>'].join(""));this.$el.empty().html(e.render()).css(this.options.css)}},_renderNodeList:function(t){var n=this,r=this.options.type=="department",i=this.options.useApprReference,s=this.options.useApprReception,o=this.options.receiveAllowType,u=this.options.useDisableNodeStyle&&o!="USER",a=[],f=Hogan.compile(['<li data-id="{{id}}" class="jstree-closed {{addClass}}" rel="org" data-email="{{email}}" {{#isDeptType}}style="background:transparent"{{/isDeptType}} data-original="{{originalEmail}}" data-childrenCount="{{childrenCount}}" data-useReception="{{useReception}}" data-useReference="{{useReference}}">','   {{^isDeptType}}<ins class="jstree-icon"></ins>{{/isDeptType}}','   <a class="" {{#useDisableNodeStyle}}{{#useApprReception}}{{^useReception}}nodeState="DISABLE"{{/useReception}}{{/useApprReception}}','										{{#useApprReference}}{{^useReference}}nodeState="DISABLE"{{/useReference}}{{/useApprReference}}','{{/useDisableNodeStyle}} data-name="{{name}}"><ins class="jstree-icon"></ins>{{name}} &nbsp;&nbsp; {{parentDepartmentName}}','{{#companyNameVisible}}<span class="part">|</span><span class="multi_company">{{companyName}}</span>{{/companyNameVisible}}</a>',"</li>"].join(""));e.each(t,function(e,o){var l=t[e+1]==undefined||t[e+1].nodeType!="department"?"jstree-last":"";r&&(l=""),o.nodeType=="department"&&a.push(f.render({name:o.name,id:o.id,email:o.email,originalEmail:o.email,useDisableNodeStyle:u,childrenCount:o.childrenCount,useReception:o.useReception,useReference:o.useReference,useApprReference:i,useApprReception:s,companyNameVisible:n.decideCompanyNameVisible(o.companyId),companyName:o.companyName,isDeptType:r,addClass:l,parentDepartmentName:o.parentDepartmentName}))}),a.length&&this.$el.find("#searchDepartmentEl").show().find("ul").html(a.join(""))},decideCompanyNameVisible:function(e){var t;_.isFunction(GO.session)?t=GO.session("companyId"):t=USERSESSION.companyId;var n=this.options.multiCompanyVisible;return n?e!=t:!1},_renderItemList:function(t){function u(){return{contact:Hogan.compile(['<li rel="contact" data-id="{{id}}" data-email="{{email}}" data-companyname="{{companyName}}" data-name="{{name}}">',"   <a data-bypass>",'       <ins class="worker"></ins>','       <span class="part" title="{{contactDisplayName}}">{{contactDisplayName}}</span>',"   </a>","</li>"].join("")),normal:Hogan.compile(['<li data-id="{{id}}" data-email="{{email}}" data-duties="{{dutyNames}}" data-dept-ids="{{departmentIds}}" data-employee-number="{{employeeNumber}}" data-thumbnail="{{thumbnail}}" data-original="{{originalEmail}}" data-loginId="{{loginId}}">',"   <a data-bypass >",'       <ins class="{{#manager}}master{{/manager}}{{^manager}}{{#isDeleteDept}}team{{/isDeleteDept}}{{^isDeleteDept}}worker{{/isDeleteDept}}{{/manager}}"></ins>',"		{{^isDeleteDept}}",'           <span class="name" title="{{name}}">{{name}}</span>',"           {{#isPosition}}",'               <span class="position" title="{{position}}">{{position}}</span>',"           {{/isPosition}}","		{{/isDeleteDept}}","       {{#isDepartments}}",'           <span class="part" title="{{^isDeleteDept}}{{departments}}{{/isDeleteDept}}{{#isDeleteDept}}{{name}}{{/isDeleteDept}}">{{^isDeleteDept}}{{departments}}{{/isDeleteDept}}{{#isDeleteDept}}{{name}}{{/isDeleteDept}}</span>',"       {{/isDepartments}}","       {{#companyNameVisible}}",'           <span class="part">|</span><span class="multi_company">{{companyName}}</span>',"       {{/companyNameVisible}}","   </a>","</li>"].join("")),deletedDept:Hogan.compile(['<li data-id="{{id}}" data-email="{{email}}" data-duties data-dept-ids data-employee-number data-thumbnail data-original data-loginId>',"   <a data-bypass >",'       <ins class="team"></ins>','       <span class="name" title="{{name}}">{{name}}</span>',"   </a>","</li>"].join(""))}}var n=this,r=this.options.isDeleteDept,i=this.options.type=="contact",s=[],o=i?u().contact:r?u().deletedDept:u().normal;e.each(t,function(e,t){if(t.nodeType!="department"){var u={id:r?t.deptId:t.id,name:t.name,email:t.email,originalEmail:t.originalEmail,position:t.position||"",isPosition:t.position?!0:!1,dutyNames:t.duties?t.duties.join("/"):"",departments:t.departments?t.departments.join("/"):"",isDepartments:t.departments?t.departments.length>0:!1,departmentIds:t.departmentIds?t.departmentIds.join(","):"",employeeNumber:t.employeeNumber,thumbnail:t.thumbnail,companyNameVisible:n.decideCompanyNameVisible(t.companyId),companyName:t.companyName,isDeleteDept:r,manager:t.manager,loginId:t.loginId};if(i){var a=[];a.push(t.name),t.email&&a.push("("+t.email+")"),u.contactDisplayName=a.join(" "),u.companyName=t.companyName}s.push(o.render(u))}}),this.$el.find("p.data_null").remove(),this.$el.find("ul.member_list").append(s.join(""))},_renderDescendantMembers:function(t){var n=[],r=Hogan.compile(['<li class="{{addClass}} jstree-leaf" data-id="{{id}}" data-email="{{email}}" data-duties="{{dutyNames}}" data-original="{{originalEmail}}" data-dept-ids="{{deptId}}" data-name="{{name}}" data-position="{{position}}" rel="{{#master}}MASTER{{/master}}{{#moderator}}MODERATOR{{/moderator}}{{^manager}}MEMBER{{/manager}}">','<ins class="jstree-icon">&nbsp;</ins><a class="ui-draggable" rel="{{#master}}MASTER{{/master}}{{#moderator}}MODERATOR{{/moderator}}{{^manager}}MEMBER{{/manager}}"><ins class="jstree-icon worker"></ins><span class="name">&nbsp;{{name}}</span> <span class="position">{{position}}</span></a>',"</li>"].join(""));return e.each(t,function(i,s){n.push(r.render(e.extend(s,{addClass:i==t.length-1?"jstree-last":""})))}),n.join("")},_renderEmptyList:function(){var e=Hogan.compile('<p class="data_null"><span class="ic_data_type ic_no_part"></span>{{msg_no_search_result}}</p>');this.$el.find("#searchDepartmentEl").hide(),this.$el.find("ul.member_list").empty().html(e.render({msg_no_search_result:this.options.i18n["\uac80\uc0c9\uacb0\uacfc\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]}))},_renderEmptyDescendantMembers:function(){var e=Hogan.compile('<li class="jstree-last jstree-leaf"><ins class="jstree-icon">&nbsp;</ins>&nbsp;{{empty_msg}}</li>');return e.render({empty_msg:this.options.i18n["\uba64\ubc84\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]})},_bindMemberEvent:function(){var t=function(t){var n=e(t.currentTarget);this.$el.find("ul").find("li>a").removeClass("jstree-clicked"),n.find("a").addClass("jstree-clicked"),_.isFunction(this.options.callback)&&this.options.callback(this._processSearchData(n),t)};this.$el.on("click contextmenu","ul.member_list > li",e.proxy(t,this))},_bindDeptEvent:function(){var t=this,n=function(t){var n=e(t.currentTarget);return this.$el.find("ul").find("li>a").removeClass("jstree-clicked"),n.children("a").addClass("jstree-clicked"),_.isFunction(this.options.callback)&&this.options.callback(this._processSearchData(n),t),!1},r=function(n){var r=e(n.currentTarget);r.attr("rel")!="org"&&(r=r.parent("[rel]")),this.$el.find("ul").find("li>a").removeClass("jstree-clicked"),r.children("a").addClass("jstree-clicked");if(_.isFunction(this.options.callback))if(this.options.isBatchAdd){var i=this._processSearchData(r);this._isPopupType(i.type)&&this._popup(i).done(function(e){t.options.callback(e,n)})}else this.options.callback(this._processSearchData(r),n);return!1},i=function(t){if(this.options.type==="department")return!1;var n=e(t.currentTarget);n.attr("rel")!="org"&&(n=n.parent("[rel]"));if(n.data("data-loaded"))n.hasClass("jstree-open")?n.removeClass("jstree-open").addClass("jstree-closed"):n.removeClass("jstree-closed").addClass("jstree-open");else{this.isAjaxDouble=!0;var r=n.attr("data-id");this._fetchDescendantMembers(r,e.proxy(function(e,t,r){n.data("data-loaded",!0),n.find("a").after("<ul />").end().removeClass("jstree-closed").addClass("jstree-open"),e.data.length?n.find("ul").html(this._renderDescendantMembers(e.data)):n.find("ul").html(this._renderEmptyDescendantMembers()),this.isAjaxDouble=!0,this._bindDNDEvent()},this))}};this.$el.on("dblclick contextmenu","ul.department_list > li > a",e.proxy(i,this)),(this.options.type=="node"||this.options.type=="department"||this.options.type=="org")&&this.$el.on("click contextmenu","ul.department_list > li > a",e.proxy(r,this)),this.$el.on("click contextmenu","ul.department_list ins.jstree-icon",e.proxy(i,this)),this.$el.on("click contextmenu","ul.department_list > li > ul > li",e.proxy(n,this))},_isPopupType:function(e){return this.options.isBatchAdd&&!this.options.isOnlyOneMember&&e=="org"&&(this.options.type=="list"||this.options.type=="node"||this.options.type=="circle")},_getScope:function(){var e;if(this.options.isAdmin)return;this.options.parentNodeIds.length||this.options.isCustomType?e=this.options.hideOrg?"none":"subdept":this.options.parentNodeIds.length>0&&(e="none")},_hasScope:function(){return this._getScope()=="none"?!1:!0},_popup:function(t){function o(t,n,r){var i=this;r=r||!1;var s={};if(this.type=="circle"){s={url:GO.config("contextRoot")+"api/org/circle/tree",type:"POST",data:JSON.stringify(this.options.circle),contentType:"application/json"};var o=_.findWhere(i.data,{metadata:{id:n}}),u=_.map(o.children,function(e){return e.metadata});return t.resolve(u)}return s={url:GO.config("contextRoot")+"api/organization/user?deptid="+n+(r?"&scope=subdept":"")},e.ajax(s).done(_.bind(function(e){var n=_.map(e,function(e){return e.metadata},this);t.resolve(n)},this)).fail(function(){t.reject()})}var n=this,r=e.Deferred(),i=new Array,s=this.options.type!="circle"&&this._hasScope(),s=!0;return i.push({btype:"confirm",btext:s?this.options.externalLang["\ud604\uc7ac \ubd80\uc11c\uc6d0\ub9cc \ucd94\uac00"]:this.options.externalLang["\ucd94\uac00"],callback:function(){o.call(n,r,t.id)}}),s&&i.push({btype:"confirm",btext:this.options.externalLang["\ud558\uc704 \ubd80\uc11c\uc6d0 \ubaa8\ub450 \ucd94\uac00"],callback:function(){o.call(n,r,t.id,!0)}}),i.push({btype:"close",btext:this.options.externalLang["\ucde8\uc18c"]}),e.goPopup({pclass:"layer_confim",title:this.options.memberTypeLabel+" "+this.options.externalLang["\ucd94\uac00"],message:GO.i18n(this.options.externalLang["{{arg1}}\uc744(\ub97c) {{arg2}}\uc5d0 \ucd94\uac00\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],{arg1:t.name,arg2:this.options.memberTypeLabel}),modal:!0,buttons:i}),r},_fetchDescendantMembers:function(t,n){e.ajax({url:this.options.contextRoot+"api/organization/user/descendant",contentType:"application/json",async:!1,type:"GET",data:{page:0,offset:300,nodeType:"department",deptid:t},success:n})},_bindDNDEvent:function(){if(this.options.isDndActive){var t=this,n=this.options.draggables,r={helper:function(t){var n=e(this).clone();return n.zIndex(11e3),n},revert:"invalid"},i={accept:n,over:function(n,r){var i=t._processSearchData(e(r.draggable).parent());t.options.dropCheck(e(n.target),i)},out:function(n,r){var i=t._processSearchData(e(r.draggable).parent());t.options.dropOut(e(n.target),i)},drop:function(n,r){var i=t._processSearchData(e(r.draggable).parent());t.options.dropFinish(e(n.target),i)}};e(n).draggable(r),e(this.options.dndDropTarget).droppable(i)}},_bindScrollEvent:function(){this.$el.on("scroll","",e.proxy(function(t){var n=e(t.currentTarget);n[0].scrollHeight-n.scrollTop()-n[0].clientHeight<1&&(this.options.page++,this.render())},this))},_processSearchData:function(e){var t=e.attr("data-dept-ids"),n=e.attr("rel")=="org",r=e.attr("rel")=="contact",i={id:e.data("id"),email:e.data("email"),originalEmail:e.data("original"),type:n?"org":"MEMBER",thumbnail:e.attr("data-thumbnail"),loginId:e.attr("data-loginId")};if(n)i.name=e.find("a:first").attr("data-name")||"",i.useReception=e.data("usereception"),i.useReference=e.data("usereference"),i.subdept=e.data("childrencount")?!0:!1;else if(r)i.id=e.data("id"),i.email=e.data("email"),i.name=e.data("name"),i.companyName=e.data("companyname");else{i.name=e.find("span.name:first").text(),t!=null&&(i.deptId=t.indexOf(",")>0?t.substring(0,t.indexOf(",")):t);var s="";e.hasClass("jstree-leaf")?s=e.parents("li").find("a:first").attr("data-name")||"":s=e.find("span.part:first").attr("title");var o=e.attr("data-duties");i.duty=o.indexOf(",")>0?o.substring(0,o.indexOf(",")):o,i.deptName=s,i.position=e.find("span.position:first").text()||"",i.displayName=i.name+" "+i.position,i.employeeNumber=e.attr("data-employee-number")}return i},getData:function(){return this.data}}}})(jQuery);