(function(e){e.goNodeTree=function(e){if(arguments[0]==="close")return this.close();var t=new n;return t.initialize(e),t};var t=1e3,n=function(){function n(t,n){var r=n.rslt.obj,i=r.find("a:first"),s=i.attr("rel");if(e(r.context).hasClass("jstree-icon"))return!0;if(!t.isBatchAdd&&t.type=="list"&&f(s))return!0;if(s=="LIMIT"){var o=t.i18n["\uacb0\uacfc\uac12\uc774 \ub9ce\uc2b5\ub2c8\ub2e4. \uac80\uc0c9\uc744 \uc774\uc6a9\ud574 \uc8fc\uc138\uc694."];return e.goSlideMessage==undefined?alert(o):e.goSlideMessage(o),!0}return!1}function r(e,t){if(e.method=="POST")return JSON.stringify(e.circle);var n={};if(typeof t.data=="function")var r=t.data();return e.isAdmin?(n={deptid:r?r.id:e.loadId},e.companyId&&(n.companyId=e.companyId),_.isEmpty(e.companyIds)||(n.companyIds=e.companyIds)):(n={deptid:r?r.id:e.loadId,includeDeptIds:r?[]:e.includeLoadIds},!r&&!n.deptid?n.type="mydept":(n.includeDeptIds.length||e.isCustomType)&&!r?(n.type="custom",n.scope=e.hideOrg?"none":"subdept"):(n.type="child",e.includeLoadIds.length>0&&(n.scope="none"),e.loadId==n.deptid&&(n.scope=e.hideOrg?"none":"subdept")),e.useApprReception&&(n.useApprReception=!0),e.useApprReference&&(n.useApprReference=!0),e.type=="contact"&&r&&(n.folderId=r.id),e.type=="contact"&&r&&(n.folderId=r.id)),n.deptid||delete n.deptid,n}function i(t,n,r){var i=n.find("a").attr("rel"),o=n.parents(".jstree-company").find('a[rel="company"]'),u=n.data(),a={};return a=e.extend(a,{id:u.id,companyId:o.attr("nodeid"),companyName:o.text()||u.companyName,email:u.email,originalEmail:u["originalEmail"]==undefined?u.email:u.originalEmail,name:u.name,type:i}),t=="node"&&f(i)&&(a.subdept=u["childrenCount"]==0?!1:!0),f(i)&&(a.code=u.code,a.useReception=u.useReception,a.useReference=u.useReference),s(i)&&(a.duty=u.duty,a.deptId=u.deptId,a.deptName=u.deptName,a.position=u.position||"",a.displayName=u.name+" "+u.position,a.thumbnail=u.thumbnail,a.employeeNumber=u.employeeNumber,a.loginId=u.loginId),a}function s(e){return u(e)||o(e)||a(e)}function o(e){return e=="MASTER"}function u(e){return e=="MEMBER"}function a(e){return e=="MODERATOR"}function f(e){return e=="org"||e=="company"}return{version:"0.0.1",popupEl:null,callback:null,contextRoot:null,eventTime:null,eventId:null,defaults:{id:"gpopupLayer",treeId:"orgTree",type:"list",isAdmin:!1,css:{minHeight:375,maxHeight:375}},template:function(e,t){return e.replace(/{(\w*)}/g,function(e,n){return t.hasOwnProperty(n)?t[n]:""})},initialize:function(t){return this.isAjaxDouble=!1,this.options=e.extend({},this.defaults,t),this.options.css&&this.options.css["overflow-y"]&&delete this.options.css["overflow-y"],this.el=this.options.el,this.$el=e(this.el),this.useSiteName=GO.config==undefined?!1:GO.config("useSiteNameConfig"),this.multiCompanyVisible=this.options.multiCompanyVisible||!1,this.circle=this.options.circle||null,this.loadId=this.options.loadId||"",this.companyIds=this.options.companyIds||[],this.companyId=this.options.companyId||null,this.includeLoadIds=this.options.includeLoadIds||[],this.type=this.options.type||this.defaults.type,this.callback=this.options.callback||"",this.contextRoot=this.options.contextRoot||"",this.isAdmin=this.options.isAdmin||this.defaults.isAdmin,this.hideOrg=this.options.hasOwnProperty("hideOrg")?this.options.hideOrg:this.loadId?!0:!1,this.target=this.options.target||null,this.isDndActive=this.options.isDndActive,this.dndDropTarget=this.options.dndDropTarget,this.draggables=this.options.draggables||"a[rel]",this.useDisableNodeStyle=_.isBoolean(this.options.useDisableNodeStyle)?this.options.useDisableNodeStyle:!1,this.useApprReception=_.isBoolean(this.options.useApprReception)?this.options.useApprReception:!1,this.useApprReference=_.isBoolean(this.options.useApprReference)?this.options.useApprReference:!1,this.receiveAllowType=this.options.receiveAllowType||"ALL",this.dropCheck=this.options.dropCheck,this.dropFinish=this.options.dropFinish,this.dropOut=this.options.dropOut,this.css=this.options.css,this.i18n=this.options.i18n,this.method=this.options.method||"GET",this.externalLang=this.options.externalLang||null,this.isOnlyOneMember=this.options.isOnlyOneMember||!1,this.memberTypeLabel=this.options.memberTypeLabel||"",this.isCustomType=this.options.isCustomType||!1,this.isBatchAdd=this.options.isBatchAdd||!1,this.displayFormats=this.options.displayFormats||null,this.render(),this},render:function(){this.deferred=e.Deferred();var s=this,o={plugins:["themes","json_data","ui","crrm"],json_data:{ajax:{type:s._ajaxType(),url:function(e){return s._url(e)},data:function(e){return r(s,e)},cache:!1,async:!0,success:function(n){s.data=s._parseNodes(n);try{var r=e("#"+s.defaults.treeId+">div");if(n.length==0&&r.find("ul>li").length<=1){var i='<p class="data_null"><span class="ic_data_type ic_no_member"></span>{msg_no_member}</p>';s.type=="list"?r.html(s.template(i,{msg_no_member:s.i18n["\uba64\ubc84\uac00 \uc5c6\uc2b5\ub2c8\ub2e4."]})):s.type=="department"&&s.isAdmin&&r.html(s.template(i,{msg_no_member:s.externalLang["\ubd80\uc11c\uac00 \uc5c6\uc2b5\ub2c8\ub2e4 \uc870\uc9c1\uc124\uacc4\uc5d0\uc11c \uc124\uc815\ud558\uc138\uc694"]}))}n.length>t&&(n=s._relocateChildNode(n)),_.each(n,function(e){e.children&&e.children.length>=t&&(e.children=s._relocateChildNode(e.children))},this)}catch(o){console.log(o)}return n},beforeSend:function(){s.deferred.resolve()}}},crrm:{input_width_limit:200,move:{check_move:function(e){return!1}}},core:{animation:120,strings:{loading:"&nbsp;"}},"defaults ":{html_titles:!0,animation:500,ccp:!1,width:200},ui:{select_multiple_modifier:!1,select_limit:1}};s.method=="POST"&&(o.json_data.ajax.contentType="application/json;",o.json_data.ajax.headers={accept:"application/json, text/json"}),this.treeEl=this.$el.jstree(o),this.treeEl.bind("load_node.jstree",function(t,n,r){e(s.popupEl).trigger("data:success",[s.target]),e(s.el+' a[href="#"]').attr({"data-bypass":1,title:""});if(s.useDisableNodeStyle){var i=e.jstree._reference(s.treeEl).get_container();i.find("li").each(function(t,n){e(n).data("useReception")==0&&s.useApprReception&&s.receiveAllowType!="USER"?e(n).children("a").first().attr("nodeState","DISABLE"):e(n).data("useReference")==0&&s.useApprReference&&s.receiveAllowType!="USER"&&e(n).children("a").first().attr("nodeState","DISABLE")})}s.$el.find('a[rel!="org"] > ins').addClass("worker").text(""),s.$el.find('a[rel="company"] > ins').removeClass("worker").addClass("company").text(""),s.$el.find('a[rel="contact"] > ins').remove(),s.$el.find('a[rel="company"]').parent("li").addClass("jstree-company");var o=!1;s.$el.find('a[rel="company"]').parent("li").each(function(t,n){var r=e(n).data("groupDepth");_.isNumber(r)||(r=0),e(n).addClass("depth"+r),!o&&parseInt(r)>=0&&(o=!0)}),o&&s.treeEl.addClass("jstree_depth"),s._bindDNDEvent(),s.deferred.resolve()}).bind("select_node.jstree",function(t,r){function u(n){e.isFunction(s.callback)&&(n.type!="company"?s.callback(n,t):n.type=="company"&&t.currentTarget.id=="orgSideTree"&&s.callback(n,t))}t.preventDefault(),t.stopPropagation();if(n(s,r))return!1;var o=i(s.type,r.rslt.obj,s.loadId);return s._isPopupType(o.type)?s._popup(o).done(function(e){u(e)}):u(o),!1}),this.treeEl.css(this.options.css);return},_relocateChildNode:function(e){var n=_.where(e,{data:{attr:{rel:"org"}}});return e[t-n.length]={data:{attr:{nodeId:null,rel:"LIMIT"},title:"...."}},n.length>0&&_.each(n,function(r,i){e[t-n.length+1+i]=r},this),e.slice(0,t+1)},_parseNodes:function(t){var n=this;return this.displayFormats?(e.isArray(t)||(t=[t]),e.map(t,function(e,t){if(!e||!e.data||!e.data.attr)return;var r=e.data.attr.rel,i=""+e.data.title,s=null;o(r)&&n.displayFormats.hasOwnProperty("orgTreeMasterFormat")?s=n.displayFormats.orgTreeMasterFormat:a(r)&&n.displayFormats.hasOwnProperty("orgTreeModeratorFormat")?s=n.displayFormats.orgTreeModeratorFormat:u(r)&&n.displayFormats.hasOwnProperty("orgTreeMemberFormat")&&(s=n.displayFormats.orgTreeMemberFormat),s&&(i=n.template(s,e.metadata)),e.data.title=i,e.data.attr.title=i,e.children&&e.children.length>0&&(e.children=n._parseNodes(e.children))}),t):t},_url:function(e){var t=this,n=[this.contextRoot,this.isAdmin?"ad/":"",this.multiCompanyVisible?"api/organization/multi/":"api/organization/"];switch(this.type){case"department":n.push("dept");break;case"user":n.push("user");break;case"contact":n=t.contextRoot+"api/contact/company/group";break;default:n.push("list")}return this.type=="circle"&&e==-1?t.contextRoot+"api/org/circle/tree":this.type=="contact"?t.contextRoot+"api/contact/companyfolder/approval":n.join("")},_ajaxType:function(){var e=this,t=this.type=="circle"?function(t){return e.type=="circle"&&typeof t!="object"?e.method="POST":e.method="GET"}:e.method;return t},_isPopupType:function(e){return this.isBatchAdd&&!this.isOnlyOneMember&&e=="org"&&(this.type=="list"||this.type=="node"||this.type=="circle")},_getScope:function(){return r(this,-1).scope},_hasScope:function(){return this._getScope()=="none"?!1:!0},_popup:function(t){function o(t,n,r){var i=this,s=n.id;r=r||!1;var o={};if(this.type=="circle"){var u=[],a=[];return this.useSiteName?u=_.findWhere(i.data[0].children,{metadata:{id:s}}):u=_.findWhere(i.data,{metadata:{id:s}}),a=_.map(u.children,function(e){return e.metadata}),t.resolve(a)}return o={url:GO.config("contextRoot")+(i.isAdmin?"ad/":"")+"api/organization/user?deptid="+s+(r?"&scope=subdept":"")},e.ajax(o).done(_.bind(function(e){var n=_.map(e,function(e){return e.metadata},this);t.resolve(n)},this)).fail(function(){t.reject()})}var n=this,r=e.Deferred(),i=new Array,s=this.type!="circle"&&this._hasScope();return i.push({btype:"confirm",btext:s?this.externalLang["\ud604\uc7ac \ubd80\uc11c\uc6d0\ub9cc \ucd94\uac00"]:this.externalLang["\ucd94\uac00"],callback:function(){o.call(n,r,t)}}),s&&i.push({btype:"confirm",btext:this.externalLang["\ud558\uc704 \ubd80\uc11c\uc6d0 \ubaa8\ub450 \ucd94\uac00"],callback:function(){o.call(n,r,t,!0)}}),i.push({btype:"close",btext:this.externalLang["\ucde8\uc18c"]}),e.goPopup({pclass:"layer_confim",title:this.memberTypeLabel+" "+this.externalLang["\ucd94\uac00"],message:GO.i18n(this.externalLang["{{arg1}}\uc744(\ub97c) {{arg2}}\uc5d0 \ucd94\uac00\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?"],{arg1:t.name,arg2:this.memberTypeLabel}),modal:!0,buttons:i}),r},_error:function(e){console.log(e)},getSelectedData:function(){var e=this.treeEl.jstree("get_selected");if(e&&e.length>0){var t=i(this.type,e,this.loadId);return t}return{}},addClassToDNDTarget:function(){this._bindDNDEvent()},_bindDNDEvent:function(){if(!this.isDndActive)return;var t=this.draggables,n={helper:function(t){var n=e(this).clone();return n.zIndex(11e3),n},revert:"invalid"},r={accept:t,over:e.proxy(function(t,n){var r=i(this.type,e(n.draggable).parent(),this.loadId);this.dropCheck(e(t.target),r)},this),out:e.proxy(function(t,n){var r=i(this.type,e(n.draggable).parent(),this.loadId);this.dropOut(e(t.target),r)},this),drop:e.proxy(function(t,n){var r=i(this.type,e(n.draggable).parent(),this.loadId);this.dropFinish(e(t.target),r)},this)};e(t,this.treeEl).draggable(n),e(this.dndDropTarget).droppable(r)}}}})(jQuery);