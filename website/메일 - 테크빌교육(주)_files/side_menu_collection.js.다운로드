//license

define("admin/collections/side_menu_collection",function(require){var e=require("backbone"),t=require("app"),n=require("underscore"),r=require("json!admin/side_menu_new.json"),i=require("json!admin/side_menu_new.custom.json"),s=require("admin/models/layout/side_menu"),o=require("admin/collections/favorite_menus"),u=e.Collection.extend({initialize:function(){this.getInaccessibleMenus(),this.initInAccessApp(),this.initServiceAdminMode(),this.initSideMenus()},initFavorite:function(){for(var e=0;e<this.arrayModels.length;e++)this.arrayModels[e].favorite=!1;this.favoriteMenus=new o,this.favoriteMenus.fetch({async:!1});for(var e=0;e<this.favoriteMenus.length;e++){var t=this.findMenu(this.favoriteMenus.models[e].getMenuKey());t&&(t.favorite=!0)}},addToArrayModels:function(e){this.arrayModels[this.modelIdx++]=e;var t=this;e.childs&&n.forEach(e.childs,function(n){e.accessible||(n.accessible=!1),t.addToArrayModels(n)})},addToSubMenuModel:function(e){var t=this;e.subMenu&&n.forEach(e.subMenu,function(e){t.arraySubMenus[t.subModelIdx++]=e})},initArrayMenus:function(){this.arrayModels=[],this.arraySubMenus=[],this.modelIdx=0,this.subModelIdx=0;var e=this;n.forEach(this.models,function(t){e.addToArrayModels(t)}),n.forEach(this.arrayModels,function(t){e.addToSubMenuModel(t)})},initSideMenus:function(){this.models=[];for(var e=0;e<r.length;e++)this.models.push(new s(r[e],this.inaccssibleMenus,this.inAccessibleApps,0,this.serviceAdminMode));for(var e=0;e<i.length;e++){var t=i[e],o=this.findParentModel(t.pUid);if(o){o.childs.push(new s(t,this.inaccssibleMenus,this.inAccessibleApps,o.depth+1,this.serviceAdminMode));continue}this.models.push(new s(t,this.inaccssibleMenus,this.inAccessibleApps,0,this.serviceAdminMode))}this.models=n.sortBy(this.models,function(e){return e.order}),this.initArrayMenus()},findParentModel:function(e,t){t=t||this.models;if(!e)return null;for(var n=0;n<t.length;n++){if(t[n].uid==e)return t[n];var r=t[n].childs;if(r&&r.length>0){var i=this.findParentModel(e,r);if(i)return i}}return null},findMenuFromHref:function(e){if(e.length<1)return undefined;var t=e.indexOf("/")!==0?e:e.substr(1);for(var n=0;n<this.arrayModels.length;n++)if(this.arrayModels[n].href===t)return this.arrayModels[n];var r=e.split("/"),i="";if(r.length<2)return undefined;for(var n=0;n<r.length-1;n++)n>0&&(i+="/"),i+=r[n];return this.findMenuFromHref(i)},findMenu:function(e){for(var t=0;t<this.arrayModels.length;t++)if(this.arrayModels[t].getMenuKey()===e)return this.arrayModels[t];return undefined},findSubMenu:function(e){for(var t=0;t<this.arraySubMenus.length;t++)if(this.arraySubMenus[t].attributes.uid===e)return this.arraySubMenus[t];return undefined},getFilteringModels:function(e){for(var t=0;t<this.models.length;t++)this.models[t].filtering(e,!1);return this.models},getMenus:function(){return this.models},isAuthorizedRoutingPath:function(e){var t=n.every(this.arrayModels,function(t){var n=t.getRoutingPath()===e&&!t.accessible;return!n});return t},getInaccessibleMenus:function(){var e=this;return $.ajax({type:"GET",url:t.contextRoot+"ad/api/domainadmin/auth/menus",async:!1}).done(function(t){e.inaccssibleMenus=t.data}),this.inaccssibleMenus},initInAccessApp:function(){var e=this._getCompanyConfig(),t=this._getLicenseConfig();this.inAccessibleApps=[];if(e&&e.config)for(key in e.config)if(e.config[key]==="off"||e.config[key]==="false"||!this._hasLicense(key,t))this.inAccessibleApps[this.inAccessibleApps.length]=key},_hasLicense:function(e,t){var n={boardService:"socialServicePack",communityService:"socialServicePack",assetService:"socialServicePack",surveyService:"socialServicePack",chatService:"mobileServicePack",pcappService:"mobileServicePack",mobileService:"mobileServicePack",mobileAppService:"mobileServicePack",worksService:"collaborationServicePack",reportService:"collaborationServicePack",todoService:"collaborationServicePack",approvalService:"approvalServicePack",docfolderService:"approvalServicePack",ehrService:"ehrServicePack",smsService:"smsServicePack",taskService:"useTaskService",storeService:"storeServicePack",allianceSystemService:"allianceSystemServicePack",openApiService:"openApiService"};return n[e]==undefined?!0:t[n[e]]?!0:!1},_getLicenseConfig:function(){var e=this;return $.ajax({type:"GET",url:t.contextRoot+"ad/api/license",async:!1,success:function(t){e.licnese=t.data}}),e.licnese},_getCompanyConfig:function(){var e=this;return $.ajax({type:"GET",url:t.contextRoot+"ad/api/system-company",async:!1,success:function(t){e.appData=t.data}}),e.appData},initServiceAdminMode:function(){var e=this;$.ajax({type:"GET",url:t.contextRoot+"ad/api/servicemode",async:!1}).done(function(t){e.serviceAdminMode=t.data})}});return u});