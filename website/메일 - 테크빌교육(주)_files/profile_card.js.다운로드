(function(){define(["backbone","app","jquery","models/profile_card","hgn!templates/profile_card","hgn!templates/profile_card_deptInfo","i18n!nls/commons","i18n!admin/nls/admin","i18n!calendar/nls/calendar","i18n!timeline/nls/timeline","jquery.go-popup","jquery.fancybox","jquery.ui"],function(e,t,n,r,i,s,o,u,a,f){var l=null,c={send_mail:o["\uc774\uba54\uc77c"],show_calendar:o["\uc77c\uc815 \ubcf4\uae30"],show_ecoupon:o["\uc120\ubb3c\ud558\uae30"],deleted_member:o["\uc0ad\uc81c\ub41c \uacc4\uc815\uc785\ub2c8\ub2e4."],direct_tel:"Rep.",phone:"Cell.",representive_tel:"Rep.",fax:"Fax.",self_info_guide:o["\uc790\uae30\uc18c\uac1c\uc11c\ub294 2\uc904\uae4c\uc9c0 \uc785\ub825\uc774 \uac00\ub2a5\ud569\ub2c8\ub2e4."],lunar_calendar:o["(\uc74c)"],"\ub2eb\uae30":o["\ub2eb\uae30"],"\uc218\uc815":o["\uc218\uc815"],"\ud68c\uc0ac\uba85":u["\ud68c\uc0ac\uba85"],"\uc804\ud654\ubc88\ud638":o["\uc804\ud654\ubc88\ud638"],"\ud68c\uc0ac\ubc88\ud638":o["\ud68c\uc0ac\ubc88\ud638"],"\uc9c1\ucc45\ubd80\uc11c":o["\uc9c1\ucc45\ubd80\uc11c"],"\ud648\ud398\uc774\uc9c0":u["\ud648\ud398\uc774\uc9c0"],"\uc774\uba54\uc77c":o["\uc774\uba54\uc77c"],"\uc0dd\uc77c":u["\uc0dd\uc77c"],"\uc8fc\uc18c":u["\uc8fc\uc18c"],"\uba54\ubaa8":o["\uba54\ubaa8"],"\uc790\uae30\uc18c\uac1c":u["\uc790\uae30\uc18c\uac1c"],"\uc9c1\ubb34":u["\uc9c1\ubb34"],"\uc9c1\uae09":u["\uc9c1\uae09"],"\uc9c1\ud1b5\uc804\ud654":o["\uc9c1\ud1b5\uc804\ud654"],"\ud734\ub300\uc804\ud654":u["\ud734\ub300\uc804\ud654"],"\ub300\ud45c\uc804\ud654":u["\ub300\ud45c\uc804\ud654"],"\ud329\uc2a4":u["\ud329\uc2a4"],"\uc704\uce58":u["\uc704\uce58"],"\uc778\uc2dd\ubc88\ud638":o["\uc778\uc2dd\ubc88\ud638"],"\uba54\uc2e0\uc800":u["\uba54\uc2e0\uc800"],"\uae30\ub150\uc77c":u["\uae30\ub150\uc77c"],"\uc9c1\ucc45\ubd80\uc11c\ub354\ubcf4\uae30":"..."+o["\ub354\ubcf4\uae30"],"\uc9c1\ucc45\ubd80\uc11c\uc811\uae30":"..."+o["\uc811\uae30"]},h=e.View.extend({initialize:function(e){this.options=e||{},this.depts=e.depts||{},this.isMultiDept=e.depts.deptMembers.length>1?!0:!1,this.isMoreView=e.depts.deptMembers.length>1?!1:!0},bindEvent:function(){n(this.$el).on("click","a.txt_link",n.proxy(this.changeDept,this))},unBindEvent:function(){n(this.$el).off("click","a.txt_link",n.proxy(this.changeDept,this))},render:function(){this.unBindEvent(),this.$el.empty();var e=this.convertView(this.depts);this.isMultiDept&&!this.isMoreView&&(e=e[0]),this.$el.append(s({depts:e,isMultiDept:this.isMultiDept,isMoreView:this.isMoreView,lang:c})),this.bindEvent()},convertView:function(e){return n(e.deptMembers).map(function(t,n){var r="";return e.profileExposureInfoModel.grade&&(r=e.grade),{position:n.deptName+"  "+(n.dutyName||"")+"  "+(r||""),team:n.parentsDeptPath||""}}).get()},changeDept:function(){this.isMoreView=!this.isMoreView,this.render()}}),p=e.View.extend({initialize:function(e){this.options=e||{},this.userId=this.options.userId,this.targetEl=this.options.targetEl,this.offset=this.options.offset,this.isAvailableCal=t.isAvailableApp("calendar"),this.isAvailableMail=t.isAvailableApp("mail"),this.isAvailableEcoupon=t.isAvailableApp("ecoupon"),this.mailExposure=t.config("mailExposure"),this.el&&this.unbindEvent()},bindEvent:function(){n(this.el).on("click","span.ic_close",n.proxy(this.checkContent,this)).on("click","span.ic_modify",n.proxy(this.checkContent,this)).on("click","a.btn_v2_calendar",n.proxy(this.checkContent,this)).on("click","a.btn_v2_ecoupon",n.proxy(this.checkContent,this)).on("click","a.btn_v2_mail",n.proxy(this.checkContent,this)).on("mouseover","#timeline_status",n.proxy(this.showTimeline,this)).on("mouseout","#timeline_status",n.proxy(this.hideTimeline,this))},showTimeline:function(){this.el.find("#timeline_message").css("display","block")},hideTimeline:function(){this.el.find("#timeline_message").css("display","none")},unbindEvent:function(){n(this.el).off("click","span.ic_close").off("click","span.ic_modify").off("click","a.btn_v2_calendar").off("click","a.btn_v2_ecoupon").off("click","a.btn_v2_mail")},showEcoupon:function(){t.router.navigate("ecoupon?type=user&id="+this.userId,{trigger:!0,pushState:!0})},showCalendar:function(){var r=this;require(["models/calendar_permission"],function(i){var s=new i({userId:r.userId});s.fetch({async:!1}),s.get("read")?t.router.navigate("calendar/user/"+r.userId,{trigger:!0,pushState:!0}):s.get("follow")?n.goPopup({title:a["\uc77c\uc815\uc744 \uc5f4\ub78c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4"],message:a["\uad00\uc2ec \ub3d9\ub8cc\uac00 \ub418\uba74 \uc77c\uc815\uc744 \uc5f4\ub78c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4"],buttons:[{btext:a["\uad00\uc2ec\ub3d9\ub8cc \uc2e0\uccad"],btype:"confirm",callback:function(){var i=t.config("contextRoot")+"api/calendar/user/"+r.userId+"/feed";e.ajax(i,{type:"POST"}).done(function(e){n.goMessage(a["\uad00\uc2ec\ub3d9\ub8cc \uc2e0\uccad\uc774 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."]),t.router.getPackageName()=="calendar"&&t.router.navigate("calendar",{trigger:!0,replace:!0})}).fail(function(){n.goMessage(a["\uad00\uc2ec\ub3d9\ub8cc \ucd94\uac00\uc2dc \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uc600\uc2b5\ub2c8\ub2e4."])})}},{btext:o["\ucde8\uc18c"],btype:"normal"}]}):n.goMessage(a["\uc0c1\ub300\ubc29\uc758 \uad00\uc2ec\ub3d9\ub8cc \uc218\ub77d\uc774 \uc644\ub8cc\ub418\uba74 \uc870\ud68c\uac00 \uac00\ub2a5\ud569\ub2c8\ub2e4."])})},checkContent:function(e){var t=n(e.currentTarget).attr("data-type");this.isEmptyContent(t)?this.performActions(t):this.contentAlert(t)},performActions:function(e){console.log(e),e=="mail"?this.moveToSendMail():e=="calendar"?this.showCalendar():e=="modify"?this.moveToMyProfile():e=="close"?n.goPopup.close():e=="ecoupon"&&this.showEcoupon()},moveToMyProfile:function(){t.router.navigate("my/profile",{trigger:!0,pushState:!0})},moveToSendMail:function(){var e=this.model.toJSON(),r=t.router.getSendMailUrl({name:e.name,position:e.position,email:e.email,department:n.isArray(e.deptMembers)&&e.deptMembers[0]?e.deptMembers[0].deptName:""});r&&window.open(r,"popupRead"+t.util.getSecureRandomInt(1,1e6),"scrollbars=yes,resizable=yes,width=1280,height=760")},convertTimelineStatus:function(e){if(!e||!e.status)return{visible:!1,status:"",message:"",duration:"",color:""};var t={visible:!0};switch(e.status){case"VACATION":t.status=f["\ud734\uac00"],t.color="state_vacation";break;case"GO_TO_WORK":t.status=f["\ucd9c\uadfc"],t.color="state_work";break;case"LEAVE_WORK":t.status=f["\ud1f4\uadfc"],t.color="";break;default:t.status=f["\ucd9c\uadfc \uc804"],t.color=""}return t.message=e.message||f["\ucd9c\uadfc \uc804 \uc785\ub2c8\ub2e4"],t.duration=e.duration||moment().format("YYYY-MM-DD(ddd)"),t},render:function(){this.model&&this.model.clear(),this.model=r.get(this.userId);var e=this.model.toJSON(),s=this.convertTimelineStatus(e.timelineOneDaySimpleModel),o=e.id==t.session("id")?!0:!1;e.contact=this.getSubContactInfo(e),e.rightSpaceItems=this.getRightSpaceItems(e),e.displayRightSpace=this.getRightSpaceStatus(e.rightSpaceItems),e.mailExposure=this.mailExposure,e.mobileNo&&e.profileExposureInfoModel.mobileNo&&(this.mobileNo=e.mobileNo);var u=i({dataset:e,isSessionId:o,timelineMessage:s,isAvailableCal:this.isAvailableCal&&t.session("companyId")==e.companyId,isAvailableMail:this.isAvailableMail,isAvailableEcoupon:this.isAvailableEcoupon&&!_.isUndefined(this.mobileNo),getDeptName:function(){var t="";return e.deptMembers.length>0?t='<span class="txt">'+e.deptMembers[0].deptName+" "+(e.deptMembers[0].dutyName||"")+" "+(e.grade||"")+"</span>"+'<span class="ic_v2 ic_profile ic_profile_tooltip" title="'+(e.deptMembers[0].parentsDeptPath||"")+'"></span>':e.profileExposureInfoModel.grade&&(t='<span class="txt">'+e.grade+"</span>"),t},lang:c,isOrgServiceOn:t.session("useOrgAccess")}),a={pclass:"layer_member_card_type2",modal:!1,contents:u,width:520,openCallback:function(){n("#gpopupLayer header").remove();var t=new h({depts:e});t.render(),this.$(".wrap_list_position_team").append(t.el)}};if(this.offset)a.offset=this.offset;else if(this.targetEl){var f=n(this.targetEl),l=f.offset(),p=n(window).width(),d=l.left+f.width()+a.width;a.offset={top:l.top+f.height()+5,left:l.left+f.width()+5};if(p<d){var v=32,m=d-p+v;a.offset.left-=m}}this.el=n.goPopup(a),this.el.draggable({handle:".handle",cursor:"move",start:function(e,t){n(this).css("bottom","")}}),this.bindEvent()},getRightSpaceStatus:function(e){var t=!1;return _.each(e,function(e){t=t||e.display}),t},getRightSpaceItems:function(e){var n=[];return n.push({display:!_.isEmpty(e.selfInfo)&&e.profileExposureInfoModel.selfInfo,title:c["\uc790\uae30\uc18c\uac1c"],"class":"",value:e.selfInfo||e.profileExposureInfoModel.selfInfo}),n.push({display:!0,title:c["\ud68c\uc0ac\uba85"],"class":"",value:e.companyName}),n.push({isDept:!0,display:!0,title:c["\uc9c1\ucc45\ubd80\uc11c"],"class":"",value:e.companyName}),n.push({display:!_.isEmpty(e.job)&&e.profileExposureInfoModel.job,value:e.job||e.profileExposureInfoModel.job,"class":"",title:c["\uc9c1\ubb34"]}),n.push({display:!_.isEmpty(e.grade)&&e.profileExposureInfoModel.grade,value:e.grade||e.profileExposureInfoModel.grade,"class":"",title:c["\uc9c1\uae09"]}),n.push({display:!_.isEmpty(e.directTel)&&e.profileExposureInfoModel.directTel,value:e.directTel||e.profileExposureInfoModel.directTel,"class":"",title:c["\uc9c1\ud1b5\uc804\ud654"]}),n.push({display:!_.isEmpty(e.mobileNo)&&e.profileExposureInfoModel.mobileNo,value:e.mobileNo||e.profileExposureInfoModel.mobileNo,"class":"",title:c["\ud734\ub300\uc804\ud654"]}),n.push({display:!_.isEmpty(e.repTel)&&e.profileExposureInfoModel.repTel,value:e.repTel||e.profileExposureInfoModel.repTel,"class":"",title:c["\ub300\ud45c\uc804\ud654"]}),n.push({display:!_.isEmpty(e.fax)&&e.profileExposureInfoModel.fax,value:e.fax||e.profileExposureInfoModel.fax,"class":"",title:c["\ud329\uc2a4"]}),n.push({display:!_.isEmpty(e.location)&&e.profileExposureInfoModel.location,value:e.location||e.profileExposureInfoModel.location,"class":"",title:c["\uc704\uce58"]}),n.push({display:!_.isEmpty(e.employeeNumber)&&e.profileExposureInfoModel.employeeNumber,value:e.employeeNumber||e.profileExposureInfoModel.employeeNumber,"class":"",title:c["\uc778\uc2dd\ubc88\ud638"]}),n.push({display:!_.isEmpty(e.birthday)&&e.profileExposureInfoModel.birthday,value:e.lunarCal?c.lunar_calendar+" "+t.util.shortDate(e.birthday):t.util.shortDate(e.birthday),"class":"",title:c["\uc0dd\uc77c"]}),n.push({display:!_.isEmpty(e.homePage)&&e.profileExposureInfoModel.homePage,value:e.homePage||e.profileExposureInfoModel.homePage,"class":"",title:c["\ud648\ud398\uc774\uc9c0"]}),n.push({display:!_.isEmpty(e.messanger)&&e.profileExposureInfoModel.messanger,value:e.messanger||e.profileExposureInfoModel.messanger,"class":"",title:c["\uba54\uc2e0\uc800"]}),n.push({display:!_.isEmpty(e.anniversary)&&e.profileExposureInfoModel.anniversary,value:t.util.shortDate(e.anniversary||e.profileExposureInfoModel.anniversary),"class":"",title:c["\uae30\ub150\uc77c"]}),n.push({display:!_.isEmpty(e.address)&&e.profileExposureInfoModel.address,value:e.address||e.profileExposureInfoModel.address,"class":"",title:c["\uc8fc\uc18c"]}),n.push({display:!_.isEmpty(e.memo)&&e.profileExposureInfoModel.memo,value:e.memo||e.profileExposureInfoModel.memo,"class":"",value:e.memo,title:c["\uba54\ubaa8"]}),n},getSubContactInfo:function(e){var t=[];return e.mobileNo&&e.profileExposureInfoModel.mobileNo&&t.push({isTop:t.length%2==0?!0:!1,title:"Cell.",number:e.mobileNo}),e.repTel&&e.profileExposureInfoModel.repTel&&t.push({isTop:t.length%2==0?!0:!1,title:"Rep.",number:e.repTel}),e.directTel&&e.profileExposureInfoModel.directTel&&t.push({isTop:t.length%2==0?!0:!1,title:"Dir.",number:e.directTel}),e.fax&&e.profileExposureInfoModel.fax&&t.push({isTop:t.length%2==0?!0:!1,title:"Fax.",number:e.fax}),t},isEmptyContent:function(e){return t.util.hasActiveEditor()&&e!="close"?!t.util.isEditorWriting():!0},contentAlert:function(e){var t=this;n.goPopup({title:"",message:o["\ub0b4\uc6a9 \uc791\uc131 \uc911 \uc774\ub3d9 \uacbd\uace0 \uba54\uc2dc\uc9c0"],modal:!0,buttons:[{btext:o["\ud655\uc778"],btype:"confirm",callback:function(){t.performActions(e)}},{btext:o["\ucde8\uc18c"],btype:"normal",callback:function(){return}}]})}});return{render:function(e,t,n){l=new p({userId:e,targetEl:t,offset:n}),l.render()}}})})(jQuery);