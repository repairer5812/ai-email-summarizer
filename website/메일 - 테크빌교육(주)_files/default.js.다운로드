define(["backbone","app","collections/notifications","hgn!templates/layouts/default","views/profile_card","views/dept_profile_card","i18n!nls/commons","i18n!nls/notification","i18n!calendar/nls/calendar","libraries/go-redirect-policy","libraries/go-nav","jquery.go-org","jquery.go-popup","go-notice","views/layouts/layoutEventListener"],function(e,t,n,r,i,s,o,u,a,f,l){function d(e,n){e.hasOwnProperty("displayFormats")||(e.displayFormats={});var r=t.config(n);_.isString(r)&&r.length>0&&(e.displayFormats[n]=v(r))}function v(e){var t=e||"";return t=t.replace(/\{\{/g,"{"),t=t.replace(/\}\}/g,"}"),t}function m(e){$(document).off("web-noti:confirm.layout").on("web-noti:confirm.layout",_.bind(function(e,t){this.onMovePage().done(function(){var e=window.open("about:blank");e.location.href=g(t.model),t.close()})},e))}function g(e){var n=t.session().companies,r=null;for(var i=0;i<n.length;i++){var s=n[i].siteUrl;e.companyId===n[i].id&&(r=location.protocol+"//"+s,location.port&&(r+=":"+location.port),r+=t.contextRoot+"tokenlogin?",r+=$.param({token:y("GOSSOcookie"),companyId:parseInt(t.session("companyId"))==parseInt(e.companyId)?null:e.companyId,returnUrl:e.linkUrl}))}return r||e.linkUrl}function y(e){var t="; "+document.cookie,n=t.split("; "+e+"=");return n.length==2?n.pop().split(";").shift():""}function b(){var e=t.router.getPackageName();if(e==="sitelink"){var n=_.filter(t.config("menuList"),function(e){return e.url===decodeURIComponent(t.router.getSearch("url"))});n.length>0&&(e=n[0].name)}return e}function w(){var e=this;e.redirectPolicy=new f,e.redirectPolicy.addPolicy("smartEditorPolicy",function(){if(!t.util.hasActiveEditor())return!0;var n=!0;return t.util.isEditorWriting()&&(n=!1),n}),e.redirectPolicy.addPolicy("mailEditorPolicy",function(){if($("#mail-viewer").length>0){var t=$("#mail-viewer")[0].contentWindow;return t.checkEscapeWriteModeForTopmenu()?!0:!1}return!0}),e.redirectPolicy.addPolicy("boardFeedPolicy",function(){var t=$("#feedContent"),n;return t.length>0?(n=t.val().replace(t.attr("placeholder"),""),!(n.length>0)):!0})}var c="hgn!templates/layouts/default",h=Array.prototype.slice,p={label:{noti_app_title:o["\uc54c\ub9bc"],management:o["\uac1c\uc778\uc815\ubcf4 \uc218\uc815"],logout:o["\ub85c\uadf8\uc544\uc6c3"],confirm:o["\ud655\uc778"],cancel:o["\ucde8\uc18c"],view_mobile:o["\ubaa8\ubc14\uc77c \ubc84\uc804\uc73c\ub85c \ubcf4\uae30"]},tpl:{overlay:'<div id="popOverlay" class="overlay" data-layer><div class="processing"></div></div>'}};return e.View.extend({el:"#main",name:"default",className:"go_skin_default",contentSize:0,contentTopMargin:0,useRedirectPolicy:!0,events:{"click #changeToMobileWeb":"changeToMobileWeb"},initialize:function(e){this.options=e||{},this.contentSize=0,this.contentTopMargin=0,this.navigationView=null,this.redirectPolicy=null;var n=!1,r=t.config("deviceType");t.config("hasMobilePack")&&(n=r==="tablet"||r==="mobile"),this.variables=_.extend({},p,{use_side:!0,use_content_wrapper:!0,use_organogram:!0,use_mobile_button:n}),this.baseConfig=t.config("__source__"),this.useRedirectPolicy&&w.call(this),m(this)},render:function(){var e=this,n=$.Deferred();e._init(),e._setAppName(),e.resetClassnames(),e.resetSideIndent(),e.renderLayout();var r=t.session()["theme"]=="THEME_ADVANCED"&&t.util.store.get(t.session("id")+"-"+"-is-mini");return typeof r=="undefined"&&(r=!1),$("body").toggleClass("mini",r),n.resolveWith(e,[e]),e.trigger("rendered:layout",[e]),$.goNotice.render({contextRoot:t.contextRoot}),window.contactGoSlideMessage=function(e,t){$.goSlideMessage(e,t||"caution")},e._decideSideVisible(),e._preventDropFile(),n},_decideSideVisible:function(){if(this._getAppName()=="none")return;var e=t.config("sideVisible")=="false-"+this._getAppName();e?(t.EventEmitter.trigger("default","side:hide"),this.hideSide()):(t.EventEmitter.trigger("default","side:show"),this.showSide())},_setAppName:function(){this.$el.attr("data-app-name",this.appName||"none")},_getAppName:function(){return this.$el.attr("data-app-name")},_init:function(){this.setUseSide(!0),this.setUseContentWrapper(!0),this.setUseOrganogram(!0),t.config("workspace_expansion_button_visible",!0)},resetClassnames:function(){this.$el.attr("class",""),this.$el.addClass(this.className),t.session()["theme"]=="THEME_ADVANCED"&&(this.$el.addClass("go_skin_advanced"),t.useMiniGnb==="true"&&this.$el.addClass("channel"),t.useLabFeedback&&t.hasLabFeedbackConfig&&this.$el.addClass("lab"))},resetSideIndent:function(){var e=this.getSideElement();this.appName=="calendar"?e.addClass("go_side_calendar"):e.removeClass("go_side_calendar")},renderLayout:function(e){e=e||!1;if(!e&&this.isMe()){t.useLabFeedback&&t.hasLabFeedbackConfig&&this.navigationView&&this.navigationView.renderLabPopUp();return}this.isMe()||requirejs.undef(c+this.getCurrentLayout()),this.setCurrentLayout(),this.setSessionInfo(),this.$el.empty().append(r(this.variables)),this.setNavigator(),this.updateNotiCount(),this._initOrganogram(),this._initRouteEvents(),this._initLayoutEvents()},setContent:function(e){var t=this.getContentContainerElement();this.removeContentView(),t.data("go-view-instance",e),t.append(e.el)},setUseSide:function(e){this.variables.use_side=e},setUseContentWrapper:function(e){this.variables.use_content_wrapper=e},isUsedContentWrapper:function(){return this.variables.use_content_wrapper},setUseOrganogram:function(e){this.variables.use_organogram=e},setSessionInfo:function(){this.variables["profile?"]=t.session()},updateNotiCount:function(){n.getNewCount(function(e){var t=$("#noti-count-badge");t.text(e),t.css("display",e==0?"none":"inline-block")})},changeToMobileWeb:function(){$.cookie("pcVersion","false",{path:"/"}),location.reload()},setNavigator:function(){var e=this.baseConfig;e.contextRoot||(e.contextRoot=t.config("contextRoot")),e.locale||(e.locale=t.config("locale")),this.navigationView=l.create("nav-placeholder",{session:t.session(),companies:t.session("integratedCompanies"),baseConfig:e,activeMenu:b(),lang:{"\ud734\uba74":o["\ud734\uba74"],"\uad00\ub9ac":o["\uad00\ub9ac"],"\ub85c\uadf8\uc544\uc6c3":o["\ub85c\uadf8\uc544\uc6c3"],"\uc54c\ub9bc":o["\uc54c\ub9bc"],"\ub300\uc2dc\ubcf4\ub4dc \ud3b8\uc9d1":o["\ub300\uc2dc\ubcf4\ub4dc \ud3b8\uc9d1"],"\uae30\ubcf8\uc815\ubcf4":o["\uae30\ubcf8\uc815\ubcf4"],"\ud658\uacbd\uc124\uc815":o["\ud658\uacbd\uc124\uc815"],"\ubcf4\uc548\uc124\uc815":o["\ubcf4\uc548\uc124\uc815"],"\ub3c4\uc6c0\ub9d0":o["\ub3c4\uc6c0\ub9d0"],"\uc5c5\ub370\uc774\ud2b8 \ud655\uc778\ud558\uae30":o["\uc5c5\ub370\uc774\ud2b8 \ud655\uc778\ud558\uae30"],"\ub2d8":o["\ub2d8"],"\uba40\ud2f0\ucef4\ud37c\ub2c8 \uc5f4\uae30":o["\uba40\ud2f0\ucef4\ud37c\ub2c8 \uc5f4\uae30"],"\uba40\ud2f0\ucef4\ud37c\ub2c8 \ub2eb\uae30":o["\uba40\ud2f0\ucef4\ud37c\ub2c8 \ub2eb\uae30"],"\uc6cc\ud06c\uc2a4\ud398\uc774\uc2a4 \ud655\uc7a5":o["\uc6cc\ud06c\uc2a4\ud398\uc774\uc2a4 \ud655\uc7a5"],"\uc6cc\ud06c\uc2a4\ud398\uc774\uc2a4 \uae30\ubcf8":o["\uc6cc\ud06c\uc2a4\ud398\uc774\uc2a4 \uae30\ubcf8"],"\uba54\ub274":o["\uba54\ub274"],"\uad00\ub9ac\uc790 \ud398\uc774\uc9c0":o["\uad00\ub9ac\uc790 \ud398\uc774\uc9c0"],"\uc11c\ube44\uc2a4 \uc0ac\uc6a9\uae30\uac04\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4.":o["\uc11c\ube44\uc2a4 \uc0ac\uc6a9\uae30\uac04\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4."],"\uc54c\ub9bc \uc124\uc815":o["\uc54c\ub9bc \uc124\uc815"],"\ub2e4\uc6b0\uc624\ud53c\uc2a4 \uc0ac\uc6a9\uc5d0 \uad00\ud55c \ubaa8\ub4e0 \uac83!":o["\ub2e4\uc6b0\uc624\ud53c\uc2a4 \uc0ac\uc6a9\uc5d0 \uad00\ud55c \ubaa8\ub4e0 \uac83!"],"\uc5b8\uc81c \uc5b4\ub514\uc11c\ub098 \ud074\ub9ad\ud574\ubcf4\uc138\uc694.":o["\uc5b8\uc81c \uc5b4\ub514\uc11c\ub098 \ud074\ub9ad\ud574\ubcf4\uc138\uc694."],"\uc0c8\ub85c\uc6b4 \ub2e4\uc6b0\uc624\ud53c\uc2a4\ub97c \ub9cc\ub098\ubcf4\uc138\uc694!":o["\uc0c8\ub85c\uc6b4 \ub2e4\uc6b0\uc624\ud53c\uc2a4\ub97c \ub9cc\ub098\ubcf4\uc138\uc694!"],"3\uac00\uc9c0 \uae30\ub2a5 \ub458\ub7ec\ubcf4\uae30":o["3\uac00\uc9c0 \uae30\ub2a5 \ub458\ub7ec\ubcf4\uae30"],"\uc0c8\ub85c\uc6b4 \uae30\ub2a5 (\uba54\ub274 \uc5f4\uae30/\ub2eb\uae30)":o["\uc0c8\ub85c\uc6b4 \uae30\ub2a5 (\uba54\ub274 \uc5f4\uae30/\ub2eb\uae30)"],"\uc0c8\ub85c\uc6b4 \uae30\ub2a5 \uc124\uba85":o["\uc0c8\ub85c\uc6b4 \uae30\ub2a5 \uc124\uba85"],"\uc870\uc9c1\ub3c4 UX \ubcc0\uacbd":o["\uc870\uc9c1\ub3c4 UX \ubcc0\uacbd"],"\uc870\uc9c1\ub3c4 UX \ubcc0\uacbd \uc124\uba85":o["\uc870\uc9c1\ub3c4 UX \ubcc0\uacbd \uc124\uba85"],"\uac1c\uc778 \uba54\ub274 \uadf8\ub8f9\ud551":o["\uac1c\uc778 \uba54\ub274 \uadf8\ub8f9\ud551"],"\uac1c\uc778 \uba54\ub274 \uadf8\ub8f9\ud551 \uc124\uba85":o["\uac1c\uc778 \uba54\ub274 \uadf8\ub8f9\ud551 \uc124\uba85"],"\uc0c8\ub85c\uc6b4 \ud3ec\ud0c8 \uc2dc\uc791":o["\uc0c8\ub85c\uc6b4 \ud3ec\ud0c8 \uc2dc\uc791"],"\ub2e4\uc74c":o["\ub2e4\uc74c"],"\uc870\uc9c1\ub3c4":o["\uc870\uc9c1\ub3c4"],"\uc124\uc815":o["\uc124\uc815"],"\uc2e4\ud5d8\uc2e4":o["\uc2e4\ud5d8\uc2e4"],"\uc790\uc138\ud788 \ubcf4\uae30":o["\uc790\uc138\ud788 \ubcf4\uae30"]},onMovePage:$.proxy(this.onMovePage,this),brandName:t.util.getBrandName(),onWorkspaceWide:$.proxy(this.hideSide,this),onWorkspaceNormal:$.proxy(this.showSide,this)})},onMovePage:function(){var e=$.Deferred();return this.useRedirectPolicy?this.redirectPolicy.allow()?e.resolve(!0):(t.util.editorWritingPopup(e),e):e.resolve(!0)},activateMenu:function(){this.navigationView.activateMenu(t.router.getPackageName())},removeContentView:function(){var e=this.getContentContainerElement();if(e.data("go-view-instance")){var t=e.data("go-view-instance"),n=_.isFunction(t.release)?t.release:t.remove;n.call(t)}},clearContent:function(){if(this.isMe()){var e=this.getContentElement(),t=this.getPopupElement();e.attr("class","").addClass("go_content"),e.empty(),t.remove(),this.clearOverlay()}this.removeContentView(),$(window).off("scroll"),$(window).off("resize"),this.navigationView&&(this.navigationView.setActiveMenu(b()),this.navigationView.reload()),this.organogram&&(this.organogram.setPosition(),this.organogram.bindPositionEvent()),window.scrollTo&&window.scrollTo(0,0)},clearPopup:function(){$("div.layer_normal").remove()},clearSide:function(){if(this.isMe()){var e=this.getSideElement();e.off(),e.empty()}},getContentHeight:function(){var e=$(window).height(),t=this.getContentElement().height(),n=this.getHeaderElement().outerHeight(),r=0;return Math.max(e-n-r,t)},resizeSide:function(){this.getSideElement().height(this.getContentHeight())},clearAll:function(){this.clearContent(),this.clearPopup(),this.clearSide(),this.activateMenu()},setOverlay:function(){this.clearOverlay(),this.$el.append(p.tpl.overlay),$(document).trigger("showLayer.goLayer")},clearOverlay:function(){this.$el.find(".overlay").remove(),$(document).trigger("hideLayer.goLayer")},targetSetOverlay:function(e){this.clearOverlay(),e.append(p.tpl.overlay),$("#popOverlay").css({position:"relative",top:"250px"})},showSide:function(){t.config("sideVisible","true-"+this._getAppName()),$("body").removeClass("go_workspace_wide");var e=this.baseConfig.displayConfigModel;e.orgPullUp&&t.session("useOrgAccess")&&t.session("theme")!=="THEME_ADVANCED"&&$("#organogram").show()},hideSide:function(){t.config("sideVisible","false-"+this._getAppName()),$("body").addClass("go_workspace_wide"),$("#organogram").hide()},getHeaderElement:function(){return this.$el.find("header.go_header")},getBodyElement:function(){return this.$el.find(".go_body")},getFooterElement:function(){return this.$el.find("footer.go_footer")},getNavigatorElement:function(){return this.$el.find("#navigator")},getSideElement:function(){return this.$el.find("#side")},getContentElement:function(){return this.$el.find("#content")},getPopupElement:function(){return this.$el.find("div.go_popup, div#popOverlay, div[class*=layer]:not(.notremoval)")},getCurrentLayout:function(){return $("body").data("layout")},getContentContainerElement:function(){return this.isUsedContentWrapper()?this.getContentElement():this.getBodyElement()},setCurrentLayout:function(){$("body").data("layout",this.name)},isMe:function(){return this.getCurrentLayout()===this.name},reset:function(){this.setLayout(!0)},_preventDropFile:function(){var e=$("#main");e.unbind("dragover"),e.unbind("drop"),e.bind("dragover",function(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="none"}),e.bind("drop",function(e){e.preventDefault(),e.stopPropagation()})},_initRouteEvents:function(){t.router.off("change:page",this.clearContent),t.router.off("change:package",this.clearAll),t.router.on("change:page",this.clearContent,this),t.router.on("change:package",this.clearAll,this)},_initLayoutEvents:function(){t.EventEmitter.on("common","layout:setOverlay",this.setOverlay,this),t.EventEmitter.on("common","layout:clearOverlay",this.clearOverlay,this),t.EventEmitter.on("common","layout:targetSetOverlay",this.targetSetOverlay,this)},_initOrganogram:function(){var e=this.baseConfig.displayConfigModel,n=".go_organogram",r={el:n,contextRoot:t.config("contextRoot"),lang:t.lang},o=$(n);if(o.length<1)return;if(!e.orgPullUp){o.hide();return}d(r,"orgTreeMasterFormat"),d(r,"orgTreeModeratorFormat"),d(r,"orgTreeMemberFormat");var u=$.goOrg(r);this.organogram=u;var a=0;t.isAdvancedTheme()||(a=this.$el.find(n).height()+25),this.getSideElement().css("padding-bottom",parseInt(a,10));var f="";u.on("show:profile",function(e,t){i.render(t.id,"",{left:220,bottom:f,position:"fixed"})}),u.on("show:dept_profile",function(e,t){s.render(t.id,"",{left:220,bottom:f,position:"fixed"})})}},{__instance__:null,create:function(){return this.__instance__===null&&(this.__instance__=new this.prototype.constructor),this.__instance__},render:function(){var e=this.create(),t=arguments.length>0?h.call(arguments):[];return this.prototype.render.apply(e,t)}})});